/**
 * NEW FILE: Prisma Database Schema - Complete Data Model
 * Purpose: Defines the database structure for Bantu's Kitchen
 * Includes: Menu items, orders, customers, receipts, and admin management
 * Database: PostgreSQL (production-ready, ACID compliant)
 * ORM: Prisma (type-safe, auto-generated client)
 */

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== CHEF MANAGEMENT (MULTI-TENANCY) =====

model Chef {
  id           String @id @default(cuid())
  name         String // "Mrs. Bantu", "Chef Ranjitha"
  businessName String // "Bantu's Kitchen"
  slug         String @unique // "bantus-kitchen" for URL

  // Contact & Location
  phone         String  @unique
  email         String  @unique
  address       String? // JSON string for SQLite: { street, city, area, pincode }
  serviceRadius Int     @default(3) // km radius for delivery

  // Legal Compliance
  fssaiNumber String?   @unique
  fssaiExpiry DateTime?
  gstNumber   String?
  isVerified  Boolean   @default(false)
  verifiedAt  DateTime?

  // Business Profile
  bio          String? // Story, specialties
  cuisineTypes String? // JSON array string for SQLite: ["Andhra", "Telangana"]
  logo         String? // Cloudinary URL
  coverImage   String?

  // Platform Status
  status      String    @default("PENDING") // PENDING, ACTIVE, SUSPENDED, INACTIVE, REJECTED
  onboardedAt DateTime?

  // Financial
  commissionRate   Float     @default(10.0) // 10% commission
  subscriptionTier String    @default("free") // free, basic, premium
  subscriptionPaid DateTime?

  // Settings
  isAcceptingOrders Boolean @default(true)
  preparationBuffer Int     @default(10) // extra minutes buffer
  minOrderAmount    Float   @default(199)

  // Relations
  menuItems MenuItem[]
  orders    Order[]
  analytics ChefAnalytics[]
  payouts   Payout[]

  // Multi-Tenant Support (optional)
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  // Tracking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([isVerified])
}

model ChefAnalytics {
  id     String @id @default(cuid())
  chefId String
  chef   Chef   @relation(fields: [chefId], references: [id], onDelete: Cascade)
  date   String // Date string for SQLite: "2025-01-01"

  ordersCount Int   @default(0)
  revenue     Float @default(0)
  platformFee Float @default(0)
  netEarnings Float @default(0)

  avgOrderValue   Float  @default(0)
  cancelledOrders Int    @default(0)
  rating          Float?

  createdAt DateTime @default(now())

  @@unique([chefId, date])
  @@index([chefId])
  @@index([date])
}

model Payout {
  id     String @id @default(cuid())
  chefId String
  chef   Chef   @relation(fields: [chefId], references: [id], onDelete: Cascade)

  amount Float
  period String // "2025-01", "2025-02"
  status String @default("PENDING") // PENDING, PROCESSING, PAID, FAILED

  ordersIncluded Int
  totalRevenue   Float
  platformFee    Float
  netAmount      Float

  paidAt        DateTime?
  paymentMethod String? // "bank_transfer", "upi"
  transactionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chefId])
  @@index([status])
  @@index([period])
}

// ===== MENU MANAGEMENT =====

model MenuItem {
  id              String  @id @default(cuid())
  name            String
  description     String
  price           Float
  originalPrice   Float?
  category        String
  image           String?
  imagePublicId   String? // Cloudinary public ID for deletion
  isVegetarian    Boolean @default(false)
  isVegan         Boolean @default(false)
  isGlutenFree    Boolean @default(false)
  isDairyFree     Boolean @default(false)
  spicyLevel      Int     @default(0)
  preparationTime Int     @default(30)
  isAvailable     Boolean @default(true) // Whether item is on menu (not about stock)
  isPopular       Boolean @default(false)
  calories        Int?
  servingSize     String?
  ingredients     String? // JSON array string for SQLite compatibility
  allergens       String? // JSON array string for SQLite compatibility

  // INVENTORY MANAGEMENT
  inventoryEnabled  Boolean @default(false) // Whether to track inventory
  inventory         Int? // Current stock count (null = unlimited)
  outOfStockMessage String? // Funny message when out of stock

  // IMAGE POSITIONING
  imagePosition String? // JSON string: {x, y, scale} for precise image positioning

  // MULTI-CHEF SUPPORT
  chefId String? // Optional: null for default restaurant
  chef   Chef?   @relation(fields: [chefId], references: [id], onDelete: Cascade)

  // Tracking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // Admin user ID

  // Relations
  orderItems       OrderItem[]
  cartReservations CartReservation[]
  demandHistory    ItemDemandHistory[]

  @@index([category])
  @@index([isAvailable])
  @@index([isPopular])
  @@index([inventoryEnabled])
  @@index([chefId])
  @@index([category, isAvailable]) // Fast category filtering
  @@index([chefId, category]) // Fast chef menu by category
  @@index([isAvailable, inventoryEnabled, inventory]) // Fast stock checks
}

// ===== ORDER MANAGEMENT =====

model Order {
  id          String @id @default(cuid())
  orderNumber String @unique // Human-readable order number - CRITICAL: Must be unique to prevent duplicates

  // MULTI-CHEF SUPPORT
  chefId        String? // Optional: null for default restaurant
  chef          Chef?   @relation(fields: [chefId], references: [id], onDelete: SetNull)
  parentOrderId String? // For multi-chef orders (group related orders)

  // Customer Info
  customerId    String? // NEW! Link to Customer for registered users
  customer      Customer? @relation("CustomerOrders", fields: [customerId], references: [id], onDelete: SetNull)
  customerName  String
  customerEmail String
  customerPhone String

  // Delivery Info
  deliveryAddress String
  deliveryCity    String
  deliveryZip     String
  deliveryNotes   String?
  latitude        Float? // NEW! For map support
  longitude       Float? // NEW! For map support

  // Order Details
  items       OrderItem[]
  subtotal    Float
  tax         Float
  deliveryFee Float
  discount    Float       @default(0)
  tip         Float       @default(0) // Tip amount from customer
  total       Float

  // Status Tracking
  status        OrderStatus   @default(PENDING_CONFIRMATION)
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String? // "cash-on-delivery", "card", "upi", "paytm", "razorpay", "stripe", etc.
  rejectionReason String? // Reason if order was rejected by kitchen (e.g., "Item(s) Out of Stock", "Kitchen Closed")

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  confirmedAt DateTime?
  preparingAt DateTime?
  readyAt     DateTime?
  deliveredAt DateTime?
  cancelledAt DateTime?

  // Grace Period Tracking (NEW! - for order modification window)
  modificationCount  Int      @default(0) // Track how many times order was modified
  gracePeriodExpiresAt DateTime? // When the modification window closes
  lastModifiedAt     DateTime? // Last time order was modified during grace period

  // Estimated times
  estimatedPrepTime Int       @default(30) // minutes
  estimatedDelivery DateTime?
  
  // Scheduled Delivery (NEW! - for pre-order system)
  isScheduledOrder     Boolean   @default(false) // True if customer selected future delivery
  scheduledDeliveryAt  DateTime? // Customer's chosen delivery time
  scheduledWindowStart DateTime? // Start of delivery window (e.g., 2:00 PM)
  scheduledWindowEnd   DateTime? // End of delivery window (e.g., 2:30 PM)
  minimumLeadTime      Int       @default(165) // Minimum minutes ahead (2h 45min = 165 min)
  prepTime             Int       @default(120) // Prep time in minutes (2 hours default)
  deliveryTime         Int       @default(45)  // Delivery time in minutes (45 min default)

  // Receipt
  receipt Receipt?

  // Payment Tracking
  payments Payment[]

  // Notification Tracking
  notifications NotificationLog[]

  // Coupon Tracking (NEW!)
  couponUsage CouponUsage?
  
  // Delivery Tracking (NEW! - Real-time GPS tracking)
  delivery Delivery?
  
  // Multi-Tenant Support (optional)
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([orderNumber])
  @@index([customerId]) // NEW! Fast customer order lookup
  @@index([customerPhone])
  @@index([status])
  @@index([createdAt])
  @@index([chefId])
  @@index([parentOrderId])
  @@index([chefId, createdAt]) // Fast chef order history
  @@index([customerPhone, status]) // Fast customer order lookup
  @@index([status, deliveredAt]) // Fast analytics queries
  @@index([paymentStatus, createdAt]) // Payment tracking
}

model OrderItem {
  id      String @id @default(cuid())
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String

  // CRITICAL FIX: Made nullable to support menu item deletion
  // When a menu item is deleted, we preserve order history by:
  // 1. Setting menuItemId to null
  // 2. Storing item details in deletedItemName/deletedItemDescription
  menuItem   MenuItem? @relation(fields: [menuItemId], references: [id])
  menuItemId String?

  // Preserve deleted item information for order history
  deletedItemName        String? // Original menu item name (if deleted)
  deletedItemDescription String? // Original item description (if deleted)
  deletedItemImage       String? // Original item image URL (if deleted)

  quantity Int
  price    Float // Price at time of order (for historical accuracy)
  subtotal Float // quantity * price

  specialInstructions String?

  @@index([orderId])
  @@index([menuItemId])
}

enum OrderStatus {
  PENDING_CONFIRMATION // Waiting for cancellation window to expire (not visible to kitchen)
  PENDING // Just received (visible to kitchen after confirmation)
  CONFIRMED // Restaurant confirmed
  PREPARING // Being cooked
  READY // Ready for pickup/delivery
  OUT_FOR_DELIVERY // On the way
  DELIVERED // Completed
  CANCELLED // Cancelled by customer or restaurant
}

enum PaymentStatus {
  PENDING // Not paid yet
  PAID // Payment received
  FAILED // Payment failed
  REFUNDED // Money returned
}

// ===== CART INVENTORY TRACKING (NEW!) =====

// Track temporary cart reservations (soft locks for urgency system)
model CartReservation {
  id         String   @id @default(cuid())
  sessionId  String // Unique session/user ID (browser fingerprint)
  menuItemId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  quantity   Int

  createdAt DateTime @default(now())
  expiresAt DateTime // 30 minutes from creation (auto-cleanup)

  @@index([menuItemId])
  @@index([sessionId])
  @@index([expiresAt])
  @@index([createdAt])
}

// Track item demand patterns for ML-powered predictions and analytics
model ItemDemandHistory {
  id         String   @id @default(cuid())
  menuItemId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  timestamp DateTime @default(now())
  hour      Int // Hour of day (0-23) for pattern analysis

  addedToCarts Int @default(0) // How many carts added this hour
  ordered      Int @default(0) // How many actually ordered
  viewCount    Int @default(0) // How many viewed item (future feature)

  // Aggregated metrics
  demandScore Float @default(0) // Average demand pressure score

  @@unique([menuItemId, timestamp])
  @@index([menuItemId])
  @@index([timestamp])
  @@index([hour])
}

// ===== RECEIPT GENERATION =====

model Receipt {
  id            String @id @default(cuid())
  receiptNumber String @unique // Human-readable (e.g., "RCP-2024-001")

  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String @unique

  // Receipt Data (snapshot at time of generation)
  receiptData Json // Complete order details as JSON

  // PDF Storage
  pdfUrl      String? // URL to stored PDF
  pdfPublicId String? // Cloud storage ID

  // Timestamps
  generatedAt DateTime  @default(now())
  emailedAt   DateTime?

  @@index([receiptNumber])
  @@index([orderId])
}

// ===== ADMIN MANAGEMENT =====

model Admin {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  phone        String?   // Phone number for admin contact
  passwordHash String
  role         AdminRole @default(STAFF)

  isActive                 Boolean   @default(true)
  emailVerified            Boolean   @default(false)
  emailVerificationToken   String?
  emailVerificationExpires DateTime?

  passwordResetToken   String?
  passwordResetExpires DateTime?

  // Password reset fields (for forgot password flow)
  resetToken           String?   @unique
  resetTokenExpires    DateTime?
  resetTokenCreatedAt  DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?
  
  // Multi-Tenant Support (optional)
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
  @@index([resetToken])
}

enum AdminRole {
  OWNER // Full access
  MANAGER // Can manage menu and orders
  STAFF // Can view and update orders only
}

// ===== PAYMENT TRACKING =====

model Payment {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Payment Gateway Info
  paymentGateway       String // "stripe", "razorpay", "cash", "cod"
  paymentMethodDetails String? // Specific method: "paytm", "form-b", "google-pay", "phonepe", "card", "netbanking", etc.
  paymentIntentId      String? // Stripe payment intent ID or Razorpay order ID
  transactionId        String? @unique // CRITICAL FIX: Unique constraint prevents duplicate payment processing from race conditions
  gatewayResponse      String? // JSON response from payment gateway

  // Amount Details
  amount     Float // Amount received (in paise/cents)
  currency   String @default("INR")
  gatewayFee Float  @default(0) // Fee charged by payment gateway
  netAmount  Float // amount - gatewayFee (actual money you receive)
  tip        Float  @default(0) // Tip amount included in payment

  // Status
  status        PaymentStatus @default(PENDING)
  failureReason String?

  // Bank Transfer Info
  payoutId     String? // Stripe payout ID or Razorpay transfer ID
  payoutStatus String? // "pending", "in_transit", "paid", "failed"
  payoutDate   DateTime? // When money was transferred to bank

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  paidAt     DateTime? // When payment was successfully received
  refundedAt DateTime?

  @@index([orderId])
  @@index([paymentIntentId])
  // @@index([transactionId]) // REMOVED: Now using @@unique constraint instead
  @@index([status])
  @@index([createdAt])
  @@index([payoutStatus])
  @@index([status, createdAt]) // Fast payment status queries
  @@index([paymentGateway, status]) // Gateway-specific queries

  /**
   * DATA INTEGRITY CONSTRAINTS (Added during comprehensive bug audit)
   * - transactionId is unique to prevent duplicate payment processing
   * - This prevents race conditions when multiple webhooks arrive simultaneously
   */
}

// ===== ANALYTICS & INSIGHTS =====

model DailySales {
  id   String   @id @default(cuid())
  date DateTime @unique

  totalOrders       Int   @default(0)
  totalRevenue      Float @default(0)
  totalTax          Float @default(0)
  totalDeliveryFees Float @default(0)

  averageOrderValue Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
}

// ===== CUSTOMER DATABASE WITH AUTHENTICATION =====

model Customer {
  id    String @id @default(cuid())
  name  String
  email String @unique
  phone String @unique

  // Authentication (NEW!)
  passwordHash String? // bcrypt hash (nullable for social login in future)

  // Email Verification (NEW!)
  emailVerified            Boolean   @default(false)
  emailVerificationToken   String?   @unique
  emailVerificationExpires DateTime?

  // Phone Verification (NEW!)
  phoneVerified             Boolean   @default(false)
  phoneVerificationOTP      String?
  phoneVerificationExpires  DateTime?
  phoneVerificationAttempts Int       @default(0)

  // Password Reset (NEW!)
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?

  // Account Status (NEW!)
  accountStatus String @default("ACTIVE") // ACTIVE, SUSPENDED, DELETED

  // Referral Code (NEW!)
  referralCode String? @unique // User's unique referral code (e.g., "RAVI-FEAST")
  referredBy   String? // ID of user who referred this user

  // Login Tracking (NEW!)
  loginAttempts Int       @default(0)
  lastLoginAt   DateTime?
  lastLoginIP   String?

  // Saved addresses
  addresses CustomerAddress[]

  // Loyalty
  totalOrders   Int   @default(0)
  totalSpent    Float @default(0)
  loyaltyPoints Int   @default(0)

  // First Order Discount (NEW!)
  firstOrderEligible Boolean @default(true) // Auto-20% discount on first order

  // Terms and Conditions Acceptance (NEW!)
  termsAccepted              Boolean @default(false)
  termsAcceptedAt            DateTime?
  termsVersion               String? // Version of terms accepted (e.g., "1.0")

  // Preferences
  dietaryPreferences String? // JSON array string for SQLite compatibility
  favoriteItems      String? // JSON array string for SQLite compatibility
  notificationPrefs  String? // JSON string: { email: true, sms: false, whatsapp: true }

  // Relations (NEW!)
  sessions           UserSession[]
  couponsUsed        CouponUsage[]
  referralsMade      Referral[]           @relation("ReferrerRelation")
  referralsReceived  Referral[]           @relation("RefereeRelation")
  orders             Order[]              @relation("CustomerOrders")
  wallet             Wallet? // Genius referral wallet
  referralMilestones ReferralMilestone[] // Jackpot milestones

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastOrderAt DateTime?

  @@index([email])
  @@index([phone])
  @@index([referralCode])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
  @@index([accountStatus])
}

model CustomerAddress {
  id         String   @id @default(cuid())
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId String

  label     String // "Home", "Work", etc.
  address   String
  city      String
  zipCode   String
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
}

// ===== NOTIFICATION TRACKING =====

model NotificationLog {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  type      String // email, sms, push, whatsapp
  channel   String // order_confirmation, status_update, payment_confirmation
  recipient String // email address or phone number
  status    String // sent, failed, pending

  sentAt       DateTime?
  failedAt     DateTime?
  errorMessage String?
  retryCount   Int       @default(0)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([status])
  @@index([createdAt])
}

// ===== COUPON & REFERRAL SYSTEM =====

model Coupon {
  id   String @id @default(cuid())
  code String @unique // "WELCOME20", "RAVI-FEAST" - CRITICAL: Unique to prevent duplicate coupons

  // Type & Ownership
  type      String // "MERCHANT" (admin-created) or "REFERRAL" (user-generated)
  createdBy String? // Admin ID (for merchant coupons) or Customer ID (for referral coupons)

  // Discount Configuration
  discountType   String // "PERCENTAGE" or "FIXED_AMOUNT"
  discountValue  Float // 20 for 20%, 50 for ₹50
  maxDiscountCap Float? // Max discount for percentage-based (e.g., ₹100 max on 20% off)
  minOrderAmount Float  @default(0) // Minimum order amount to apply coupon

  // Usage Limits
  maxUsageTotal   Int? // Total uses allowed (null = unlimited)
  maxUsagePerUser Int  @default(1) // Uses per user (default: 1)
  usageCount      Int  @default(0) // WARNING: Race condition possible - should use atomic increment

  // Validity
  validFrom  DateTime  @default(now())
  validUntil DateTime?
  isActive   Boolean   @default(true)

  // Restrictions
  firstOrderOnly       Boolean @default(false) // Only for first-time users
  applicableCategories String? // JSON array of category names (null = all categories)

  // Description
  title       String? // "Welcome Offer", "Friend Referral"
  description String? // "Get 20% off on your first order"

  // Relations
  usages CouponUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([type])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@index([createdBy])
}

model CouponUsage {
  id String @id @default(cuid())

  // Relations
  couponId String
  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  orderId String @unique // One coupon per order
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Discount Applied
  discountAmount Float // Actual discount given (e.g., ₹50)
  orderTotal     Float // Total before discount
  finalTotal     Float // Total after discount

  // Metadata
  usedAt    DateTime @default(now())
  ipAddress String? // Track for fraud prevention

  @@unique([couponId, orderId]) // Prevent duplicate usage
  @@index([couponId])
  @@index([customerId])
  @@index([orderId])
  @@index([usedAt])
}

model Referral {
  id String @id @default(cuid())

  // Participants
  referrerId String // User who shared the code
  referrer   Customer @relation("ReferrerRelation", fields: [referrerId], references: [id], onDelete: Cascade)

  refereeId String // User who used the code
  referee   Customer @relation("RefereeRelation", fields: [refereeId], references: [id], onDelete: Cascade)

  // Referral Details
  referralCode String // Code that was used

  // Rewards
  referrerReward Float @default(0) // Points or discount for referrer
  refereeReward  Float @default(0) // Discount for referee

  // Status
  status String @default("PENDING") // PENDING, COMPLETED, EXPIRED, PENDING_VERIFICATION

  // Conversion Tracking
  firstOrderId String? // Referee's first order (triggers reward)
  completedAt  DateTime? // When referral was completed
  
  // Fraud Detection (NEW!)
  fraudScore         Int      @default(0) // Risk score 0-100
  deliveryConfirmed  Boolean  @default(false) // Confirmed delivery before reward
  ipAddress          String? // IP address of referee at signup
  deviceFingerprint  String? // Browser fingerprint
  rewardPaidAt       DateTime? // When wallet credit was issued
  
  // Auto-discount tracking
  refereeDiscountApplied Boolean @default(false) // Whether referee got their ₹50 discount

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([refereeId]) // Each user can be referred only once
  @@index([referrerId])
  @@index([refereeId])
  @@index([referralCode])
  @@index([status])
  @@index([fraudScore])
  @@index([deliveryConfirmed])
}

// ===== WALLET SYSTEM (GENIUS REFERRAL REWARDS) =====

model Wallet {
  id         String @id @default(cuid())
  customerId String @unique
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Balance tracking
  balance     Float @default(0) // Current available balance
  totalEarned Float @default(0) // Lifetime earnings
  totalSpent  Float @default(0) // Lifetime spending
  
  // Pending balance (24-hour hold for fraud prevention)
  pendingBalance Float @default(0) // Amount waiting for clearance
  
  // Relations
  transactions WalletTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([balance])
}

model WalletTransaction {
  id       String @id @default(cuid())
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  // Transaction details
  type   String // CREDIT, DEBIT, PENDING_CREDIT
  amount Float // Transaction amount
  
  // Source tracking
  source      String // REFERRAL_REWARD, JACKPOT, ORDER_PAYMENT, ADMIN_CREDIT, REFUND
  sourceId    String? // referralId, milestoneId, or orderId
  description String? // Human-readable description
  
  // Balance snapshot
  balanceAfter        Float // Balance after this transaction
  pendingBalanceAfter Float @default(0) // Pending balance after transaction
  
  // Clearance tracking (for pending credits)
  clearsAt  DateTime? // When pending credit becomes available
  clearedAt DateTime? // When actually cleared
  
  // Metadata
  metadata String? // JSON string for additional data
  
  createdAt DateTime @default(now())

  @@index([walletId])
  @@index([type])
  @@index([source])
  @@index([createdAt])
  @@index([clearsAt])
}

model ReferralMilestone {
  id         String @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Milestone details
  milestoneType String // FIFTH_REFERRAL, TENTH_REFERRAL, TWENTIETH_REFERRAL, MONTHLY_CHAMPION
  milestoneCount Int // 5, 10, 20, etc.
  rewardAmount   Float // Jackpot amount (₹200-₹1000 for referrals, ₹5000 for champion)
  
  // Status
  status String @default("PENDING") // PENDING, PAID, CANCELLED
  
  // Payment tracking
  triggeredAt DateTime @default(now())
  paidAt      DateTime?
  
  // Associated transaction
  transactionId String? // WalletTransaction ID when paid
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([milestoneType])
  @@index([status])
  @@index([triggeredAt])
}

// ===== USER SESSION MANAGEMENT =====

model UserSession {
  id String @id @default(cuid())

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Token
  tokenHash String @unique // SHA-256 hash of JWT token

  // Session Info
  expiresAt DateTime
  isRevoked Boolean  @default(false)

  // Device Tracking
  userAgent  String?
  ipAddress  String?
  deviceInfo String? // JSON string: { os, browser, device }

  // Timestamps
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())

  @@index([customerId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([isRevoked])
}

// ===== SMART KITCHEN INTELLIGENCE SYSTEM =====

// Real-time kitchen capacity tracking for dynamic pricing
model KitchenCapacity {
  id           String   @id @default(cuid())
  restaurantId String   @default("default") // Multi-tenant support
  timestamp    DateTime @default(now())

  // Capacity Metrics
  currentOrders        Int // Orders being prepared now
  maxCapacity          Int // Maximum concurrent orders kitchen can handle
  utilizationPercent   Float // Calculated: (currentOrders / maxCapacity) * 100
  estimatedWaitMinutes Int // Estimated wait time for new orders
  staffOnDuty          Int // Number of staff currently working

  // Kitchen State
  status String @default("OPERATIONAL") // OPERATIONAL, OVERWHELMED, IDLE, CLOSED

  @@index([restaurantId, timestamp])
  @@index([timestamp])
  @@index([restaurantId])
}

// Ingredient-level inventory tracking for waste prevention
model IngredientInventory {
  id           String @id @default(cuid())
  name         String // "Chicken Breast", "Tomato", "Butter"
  restaurantId String @default("default")

  // Stock Information
  currentStock Float // Quantity in stock (e.g., 5.5)
  unit         String // "kg", "liters", "pieces", "grams"
  costPerUnit  Float // Procurement cost per unit

  // Expiry Tracking
  expiryDate       DateTime // When this batch expires
  hoursUntilExpiry Int // Calculated field for quick queries

  // Reordering
  minimumStock  Float // Reorder threshold
  lastRestocked DateTime @default(now())

  // Relations to Menu Items
  affectedMenuItems String? // JSON array of menu item IDs that use this ingredient

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId, expiryDate])
  @@index([hoursUntilExpiry])
  @@index([name])
  @@index([expiryDate])
}

// ML training data for demand forecasting
model DemandPrediction {
  id         String   @id @default(cuid())
  menuItemId String
  timestamp  DateTime @default(now())

  // Time Features
  hourOfDay Int // 0-23
  dayOfWeek Int // 0-6 (0 = Sunday)
  isHoliday Boolean @default(false)
  isWeekend Boolean @default(false)

  // External Features
  weatherCondition String? // "sunny", "rainy", "cold", "hot"
  temperature      Float? // Temperature in Celsius

  // Historical Context
  rollingAvg7Days  Float? // 7-day rolling average for this item
  rollingAvg30Days Float? // 30-day rolling average

  // Ground Truth (Actual Data)
  actualOrders Int @default(0) // What actually happened

  // Model Predictions
  predictedOrders    Int? // What the model predicted
  predictionAccuracy Float? // How accurate was the prediction (0-100%)

  // Confidence
  confidence      Float? // Model confidence (0-1)
  confidenceLower Int? // Lower bound of confidence interval
  confidenceUpper Int? // Upper bound of confidence interval

  // Model Info
  modelVersion String? // Track which model version made prediction

  @@unique([menuItemId, timestamp])
  @@index([menuItemId])
  @@index([timestamp])
  @@index([hourOfDay, dayOfWeek])
  @@index([menuItemId, hourOfDay])
}

// Price adjustment tracking and analytics
model DynamicPricing {
  id         String   @id @default(cuid())
  menuItemId String
  timestamp  DateTime @default(now())

  // Pricing
  originalPrice   Float // Base price from menu
  adjustedPrice   Float // Dynamically calculated price
  discountPercent Float @default(0) // Percentage discount/increase

  // Adjustment Factors
  adjustmentReason String // PEAK_DEMAND, LOW_CAPACITY, EXPIRY_RISK, IDLE_KITCHEN, SURGE_PRICING
  demandScore      Float  @default(0) // 0-100
  capacityScore    Float  @default(0) // 0-100
  expiryScore      Float  @default(0) // 0-100

  // Algorithm Tracking
  algorithmVersion String @default("v1.0")

  // Context at Time of Pricing
  kitchenUtilization Float? // Kitchen capacity at this moment
  predictedDemand    Int? // Forecasted orders for next hour
  hoursToExpiry      Float? // Hours until ingredients expire

  // Customer Impact
  timesViewed    Int    @default(0) // How many customers saw this price
  conversionRate Float? // % who bought at this price

  @@index([menuItemId, timestamp])
  @@index([timestamp])
  @@index([adjustmentReason])
  @@index([menuItemId])
}

// Comprehensive order metrics for ML training
model OrderMetrics {
  id        String   @id @default(cuid())
  orderId   String   @unique
  timestamp DateTime @default(now())

  // Timing Features
  orderPlacedHour   Int // 0-23
  orderPlacedDay    Int // 0-6
  orderPlacedMinute Int // 0-59 for granular patterns

  // Order Performance
  preparationTime Int? // Actual minutes taken to prepare
  deliveryTime    Int? // Actual minutes taken to deliver
  totalTime       Int? // Order to delivery total time

  // Kitchen State at Order Time
  kitchenUtilization Float? // Kitchen capacity when order placed
  ordersInQueue      Int? // How many orders ahead
  staffOnDuty        Int?

  // Order Details
  itemsPurchased String // JSON array of {itemId, quantity, price}
  itemCount      Int // Total number of items
  totalValue     Float // Order total

  // External Context
  weatherAtTime     String? // Weather condition when ordered
  temperatureAtTime Float? // Temperature when ordered

  // Customer Behavior
  customerIsReturning Boolean @default(false) // Is this a repeat customer?
  daysSinceLastOrder  Int? // For repeat customers

  // Outcome
  wasCompleted       Boolean @default(true) // Did order complete successfully?
  wasCancelled       Boolean @default(false)
  cancellationReason String? // If cancelled

  @@index([orderId])
  @@index([timestamp])
  @@index([orderPlacedHour, orderPlacedDay])
}

// ===== LEGAL COMPLIANCE & DATA PROTECTION =====

// Legal acceptance tracking (mandatory before usage)
model LegalAcceptance {
  id            String   @id @default(cuid())
  userId        String?
  sessionId     String   // For non-logged-in users
  documentType  String   // "TERMS", "PRIVACY", "REFUND", "FOOD_SAFETY"
  version       String   // "2.0", "3.0"
  acceptedAt    DateTime @default(now())
  ipAddress     String
  userAgent     String
  acceptMethod  String   // "MODAL", "CHECKBOX", "SIGNUP"
  
  @@index([userId])
  @@index([sessionId])
  @@index([documentType, version])
}

// Data retention for tax compliance (7 years)
model ArchivedOrder {
  id              String   @id @default(cuid())
  originalOrderId String   @unique
  orderData       Json     // Complete order snapshot
  archivedAt      DateTime @default(now())
  retainUntil     DateTime // 7 years from order date
  taxYear         String   // "FY2024-25"
  financialPeriod String   // "Q1", "Q2", "Q3", "Q4"
  
  @@index([retainUntil])
  @@index([taxYear])
}

// Data retention audit log
model DataRetentionLog {
  id          String   @id @default(cuid())
  recordType  String   // "order", "payment", "user"
  recordId    String
  action      String   // "archived", "deleted", "retained", "reviewed"
  reason      String   // "tax_compliance", "legal_hold", "gdpr_request"
  performedAt DateTime @default(now())
  performedBy String?  // Admin ID if manual
  details     Json?    // Additional context
  
  @@index([recordType])
  @@index([performedAt])
}

// Security breach tracking (72-hour notification)
model SecurityBreach {
  id              String   @id @default(cuid())
  severity        String   // "CRITICAL", "HIGH", "MEDIUM", "LOW"
  breachType      String   // "unauthorized_access", "data_leak", "sql_injection"
  affectedRecords Int
  affectedUsers   Json     // Array of user IDs/emails
  detectedAt      DateTime @default(now())
  notifiedAt      DateTime? // Must be within 72 hours
  resolvedAt      DateTime?
  dpbReportedAt   DateTime? // Data Protection Board notification
  description     String
  rootCause       String?
  mitigationSteps Json
  
  @@index([detectedAt])
  @@index([severity])
  @@index([notifiedAt])
}

// DPO request tracking (30-day SLA)
model DPORequest {
  id              String   @id @default(cuid())
  userId          String?
  email           String
  phone           String?
  requestType     String   // "DATA_ACCESS", "DATA_DELETION", "DATA_CORRECTION", "CONSENT_WITHDRAWAL"
  description     String
  requestedAt     DateTime @default(now())
  dueDate         DateTime // 30 days from request (DPDPA § 12(2))
  acknowledgedAt  DateTime?
  respondedAt     DateTime?
  status          String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, REJECTED
  response        String?
  rejectionReason String?
  isOverdue       Boolean  @default(false)
  escalatedAt     DateTime?
  
  @@index([requestType])
  @@index([dueDate])
  @@index([isOverdue])
  @@index([status])
}

// Cookie consent tracking (GDPR/DPDPA)
model CookieConsent {
  id               String   @id @default(cuid())
  userId           String?
  sessionId        String
  essential        Boolean  @default(true)  // Always true (required)
  analytics        Boolean  @default(false)
  marketing        Boolean  @default(false)
  consentedAt      DateTime @default(now())
  lastUpdated      DateTime @updatedAt
  ipAddress        String?
  userAgent        String?
  withdrawnAt      DateTime?
  
  @@index([userId])
  @@index([sessionId])
  @@index([consentedAt])
}

// User deletion requests (Right to Erasure)
model UserDeletionRequest {
  id              String   @id @default(cuid())
  userId          String   @unique
  reason          String?
  requestedAt     DateTime @default(now())
  gracePeriodEnds DateTime // 30 days from request
  cancelledAt     DateTime?
  executedAt      DateTime?
  hasLegalHold    Boolean  @default(false) // Pending litigation
  hasActiveOrders Boolean  @default(false) // Orders not yet delivered
  legalHoldReason String?
  
  @@index([userId])
  @@index([gracePeriodEnds])
  @@index([executedAt])
}

// Compliance alerts and notifications
model ComplianceAlert {
  id          String   @id @default(cuid())
  alertType   String   // "RETENTION_DUE", "BREACH_DETECTED", "DPO_OVERDUE", "LICENSE_EXPIRING"
  severity    String   // "CRITICAL", "HIGH", "MEDIUM", "LOW"
  title       String
  description String
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?
  assignedTo  String?  // Admin ID
  
  @@index([alertType])
  @@index([severity])
  @@index([resolvedAt])
}

// Comprehensive audit log for all compliance actions
model AuditLog {
  id          String   @id @default(cuid())
  action      String   // "LOGIN_FAILED", "DATA_ACCESSED", "LEGAL_ACCEPTED", "BREACH_DETECTED", etc.
  entityType  String   // "user", "order", "security_breach", "dpo_request", etc.
  entityId    String?  // ID of affected entity
  userId      String?  // User who performed action (if applicable)
  sessionId   String?  // Session ID for anonymous actions
  ipAddress   String?
  userAgent   String?
  details     Json?    // Additional context
  createdAt   DateTime @default(now())
  
  @@index([action])
  @@index([entityType])
  @@index([userId])
  @@index([createdAt])
  @@index([ipAddress])
}

// ===== DATABASE-LEVEL AUDIT TRAIL (GENIUS ARCHITECTURE) =====

// Database change tracking - logs all DDL/DML operations for complete audit trail
// This provides defense-in-depth: even if app-level logging fails, database changes are captured
model DatabaseChange {
  id              String   @id @default(cuid())
  occurredAt      DateTime @default(now())
  actor           String?  // User ID or system role
  clientAddr      String?  // IP address
  appName         String   @default("bantus-kitchen") // Application identifier
  txId            String?  // Transaction ID for grouping related changes
  changeKind      String   // 'ddl', 'dml', 'storage'
  commandTag      String?  // 'CREATE TABLE', 'INSERT', 'UPDATE', 'DELETE', etc.
  objectType      String?  // 'table', 'column', 'index', 'trigger'
  objectIdentity  String?  // Fully qualified name (schema.table)
  statement       String? // SQL statement text (when available)
  details         Json?    // Additional metadata (old/new values, row count, etc.)
  
  @@index([occurredAt])
  @@index([changeKind])
  @@index([objectType])
  @@index([actor])
  @@index([commandTag])
  @@map("database_changes")
}

// ===== DELIVERY TRACKING SYSTEM (REAL-TIME GPS) =====

// Delivery Partner/Driver Management
model DeliveryPartner {
  id          String @id @default(cuid())
  name        String
  phone       String @unique
  email       String? @unique
  vehicleType String // "bike", "scooter", "car", "bicycle"
  vehicleNumber String?
  
  // Real-time location (updated every 5 seconds during delivery)
  currentLat  Float?
  currentLng  Float?
  lastPingAt  DateTime?
  
  // Status
  isOnline    Boolean @default(false) // Is app open and location sharing
  isAvailable Boolean @default(true)  // Available to accept new orders
  
  // Performance metrics
  totalDeliveries  Int @default(0)
  rating           Float?
  completionRate   Float @default(0) // Percentage of orders completed
  averageTime      Int? // Average delivery time in minutes
  
  // Relations
  deliveries  Delivery[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([isOnline, isAvailable]) // Fast lookup for available drivers
  @@index([phone])
  @@index([currentLat, currentLng]) // Geospatial queries
}

// Delivery Tracking Record (One per order)
model Delivery {
  id        String @id @default(cuid())
  orderId   String @unique
  order     Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Assigned driver
  partnerId String?
  partner   DeliveryPartner? @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  
  // Route coordinates
  pickupLat    Float // Chef/Restaurant location
  pickupLng    Float
  dropoffLat   Float // Customer location
  dropoffLng   Float
  
  // Tracking status
  status           String @default("PENDING") // PENDING, ASSIGNED, PICKED_UP, IN_TRANSIT, ARRIVED, DELIVERED, CANCELLED
  estimatedArrival DateTime?
  actualArrival    DateTime?
  
  // Distance and time
  distanceKm       Float? // Total distance
  estimatedMinutes Int? // ETA in minutes
  actualMinutes    Int? // Actual time taken
  
  // Path tracking (breadcrumb trail for replay)
  pathPoints Json? // Array of {lat, lng, timestamp, speed}
  
  // Driver earnings
  deliveryFee      Float @default(0)
  driverPayout     Float @default(0) // Amount paid to driver
  
  // Timestamps
  assignedAt    DateTime? // When driver accepted
  pickedUpAt    DateTime? // When driver picked up from kitchen
  deliveredAt   DateTime? // When delivered to customer
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([orderId])
  @@index([partnerId])
  @@index([status])
  @@index([createdAt])
}

// Add Delivery relation to Order model (needs manual addition to Order model above)
// In Order model, add: delivery Delivery?

// ===== WHITE-LABEL SAAS MULTI-TENANCY =====

// Tenant/Platform Management (Each city/region can have its own instance)
model Tenant {
  id          String @id @default(cuid())
  slug        String @unique // "delhi-home-chefs", "mumbai-kitchen", "bangalore-eats"
  name        String // "Delhi Home Chefs"
  domain      String? @unique // Optional custom domain (delhi.gharse.com)
  
  // Branding
  logo          String?
  primaryColor  String @default("#FF6B35") // Orange
  secondaryColor String @default("#FFA500") // Amber
  favicon       String?
  
  // Subscription & Billing
  plan          String @default("FREE") // FREE, STARTER, PROFESSIONAL, ENTERPRISE
  subscriptionStatus String @default("TRIAL") // TRIAL, ACTIVE, SUSPENDED, CANCELLED
  trialEndsAt   DateTime?
  billingCycle  String? // "monthly", "annual"
  monthlyPrice  Float @default(0) // What they pay per month
  
  // Usage limits (based on plan)
  maxChefs      Int @default(5) // FREE: 5, STARTER: 25, PROFESSIONAL: 100, ENTERPRISE: unlimited
  maxOrders     Int @default(100) // Per month
  maxMenuItems  Int @default(50)
  maxStorage    Int @default(1) // GB
  
  // Current usage (tracked monthly)
  currentChefs     Int @default(0)
  currentOrders    Int @default(0)
  currentMenuItems Int @default(0)
  currentStorage   Float @default(0) // MB
  
  // Revenue tracking
  monthlyRevenue Float @default(0) // Total GMV this month
  commission     Float @default(15) // Platform commission % (parent takes cut)
  
  // Contact
  ownerName      String?
  ownerEmail     String?
  ownerPhone     String?
  
  // Settings
  isActive       Boolean @default(true)
  allowNewChefs  Boolean @default(true)
  requireApproval Boolean @default(true)
  
  // Relations
  chefs         Chef[]
  orders        Order[]
  admins        Admin[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([slug])
  @@index([domain])
  @@index([plan])
  @@index([subscriptionStatus])
}

// Add tenantId to existing models (manual additions needed):
// Chef: tenantId String?, tenant Tenant?
// Order: tenantId String?, tenant Tenant?
// Admin: tenantId String?, tenant Tenant?
