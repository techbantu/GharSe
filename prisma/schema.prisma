/**
 * NEW FILE: Prisma Database Schema - Complete Data Model
 * Purpose: Defines the database structure for Bantu's Kitchen
 * Includes: Menu items, orders, customers, receipts, and admin management
 * Database: PostgreSQL (production-ready, ACID compliant)
 * ORM: Prisma (type-safe, auto-generated client)
 */

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"  // Changed from sqlite to postgresql for Supabase
  url      = env("DATABASE_URL")
}

// ===== CHEF MANAGEMENT (MULTI-TENANCY) =====

model Chef {
  id           String @id @default(cuid())
  name         String // "Mrs. Bantu", "Chef Ranjitha"
  businessName String // "Bantu's Kitchen"
  slug         String @unique // "bantus-kitchen" for URL

  // Contact & Location
  phone         String  @unique
  email         String  @unique
  address       String? // JSON string for SQLite: { street, city, area, pincode }
  serviceRadius Int     @default(3) // km radius for delivery

  // Legal Compliance
  fssaiNumber String?   @unique
  fssaiExpiry DateTime?
  gstNumber   String?
  isVerified  Boolean   @default(false)
  verifiedAt  DateTime?

  // Business Profile
  bio          String? // Story, specialties
  cuisineTypes String? // JSON array string for SQLite: ["Andhra", "Telangana"]
  logo         String? // Cloudinary URL
  coverImage   String?

  // Platform Status
  status      String    @default("PENDING") // PENDING, ACTIVE, SUSPENDED, INACTIVE, REJECTED
  onboardedAt DateTime?

  // Financial
  commissionRate   Float     @default(10.0) // 10% commission
  subscriptionTier String    @default("free") // free, basic, premium
  subscriptionPaid DateTime?

  // Settings
  isAcceptingOrders Boolean @default(true)
  preparationBuffer Int     @default(10) // extra minutes buffer
  minOrderAmount    Float   @default(199)

  // Relations
  menuItems MenuItem[]
  orders    Order[]
  analytics ChefAnalytics[]
  payouts   Payout[]

  // Tracking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([isVerified])
}

model ChefAnalytics {
  id     String @id @default(cuid())
  chefId String
  chef   Chef   @relation(fields: [chefId], references: [id], onDelete: Cascade)
  date   String // Date string for SQLite: "2025-01-01"

  ordersCount Int   @default(0)
  revenue     Float @default(0)
  platformFee Float @default(0)
  netEarnings Float @default(0)

  avgOrderValue   Float  @default(0)
  cancelledOrders Int    @default(0)
  rating          Float?

  createdAt DateTime @default(now())

  @@unique([chefId, date])
  @@index([chefId])
  @@index([date])
}

model Payout {
  id     String @id @default(cuid())
  chefId String
  chef   Chef   @relation(fields: [chefId], references: [id], onDelete: Cascade)

  amount Float
  period String // "2025-01", "2025-02"
  status String @default("PENDING") // PENDING, PROCESSING, PAID, FAILED

  ordersIncluded Int
  totalRevenue   Float
  platformFee    Float
  netAmount      Float

  paidAt        DateTime?
  paymentMethod String? // "bank_transfer", "upi"
  transactionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chefId])
  @@index([status])
  @@index([period])
}

// ===== MENU MANAGEMENT =====

model MenuItem {
  id              String  @id @default(cuid())
  name            String
  description     String
  price           Float
  originalPrice   Float?
  category        String
  image           String?
  imagePublicId   String? // Cloudinary public ID for deletion
  isVegetarian    Boolean @default(false)
  isVegan         Boolean @default(false)
  isGlutenFree    Boolean @default(false)
  spicyLevel      Int     @default(0)
  preparationTime Int     @default(30)
  isAvailable     Boolean @default(true) // Whether item is on menu (not about stock)
  isPopular       Boolean @default(false)
  calories        Int?
  servingSize     String?
  ingredients     String? // JSON array string for SQLite compatibility
  allergens       String? // JSON array string for SQLite compatibility

  // INVENTORY MANAGEMENT
  inventoryEnabled  Boolean @default(false) // Whether to track inventory
  inventory         Int? // Current stock count (null = unlimited)
  outOfStockMessage String? // Funny message when out of stock

  // IMAGE POSITIONING
  imagePosition String? // JSON string: {x, y, scale} for precise image positioning

  // MULTI-CHEF SUPPORT
  chefId String? // Optional: null for default restaurant
  chef   Chef?   @relation(fields: [chefId], references: [id], onDelete: Cascade)

  // Tracking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // Admin user ID

  // Relations
  orderItems       OrderItem[]
  cartReservations CartReservation[]
  demandHistory    ItemDemandHistory[]
  ratings          DishRating[]

  @@index([category])
  @@index([isAvailable])
  @@index([isPopular])
  @@index([inventoryEnabled])
  @@index([chefId])
  @@index([category, isAvailable]) // Fast category filtering
  @@index([chefId, category]) // Fast chef menu by category
  @@index([isAvailable, inventoryEnabled, inventory]) // Fast stock checks
}

// ===== ORDER MANAGEMENT =====

model Order {
  id          String @id @default(cuid())
  orderNumber String @unique // Human-readable order number - CRITICAL: Must be unique to prevent duplicates

  // MULTI-CHEF SUPPORT
  chefId        String? // Optional: null for default restaurant
  chef          Chef?   @relation(fields: [chefId], references: [id], onDelete: SetNull)
  parentOrderId String? // For multi-chef orders (group related orders)

  // Customer Info
  customerId    String? // NEW! Link to Customer for registered users
  customer      Customer? @relation("CustomerOrders", fields: [customerId], references: [id], onDelete: SetNull)
  customerName  String
  customerEmail String
  customerPhone String

  // Delivery Info
  deliveryAddress String
  deliveryCity    String
  deliveryZip     String
  deliveryNotes   String?

  // Order Details
  items       OrderItem[]
  subtotal    Float
  tax         Float
  deliveryFee Float
  discount    Float       @default(0)
  tip         Float       @default(0) // Tip amount from customer
  total       Float

  // Status Tracking
  status        OrderStatus   @default(PENDING_CONFIRMATION)
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String? // "cash-on-delivery", "card", "upi", "paytm", "razorpay", "stripe", etc.

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  confirmedAt DateTime?
  preparingAt DateTime?
  readyAt     DateTime?
  deliveredAt DateTime?
  cancelledAt DateTime?

  // Grace Period Tracking (NEW! - for order modification window)
  modificationCount  Int      @default(0) // Track how many times order was modified
  gracePeriodExpiresAt DateTime? // When the modification window closes
  lastModifiedAt     DateTime? // Last time order was modified during grace period

  // Estimated times
  estimatedPrepTime Int       @default(30) // minutes
  estimatedDelivery DateTime?

  // Receipt
  receipt Receipt?

  // Payment Tracking
  payments Payment[]

  // Notification Tracking
  notifications NotificationLog[]

  // Coupon Tracking (NEW!)
  couponUsage CouponUsage?

  // Delivery Tracking (NEW!)
  delivery Delivery?

  // Ratings (NEW!)
  ratings DishRating[]

  @@index([orderNumber])
  @@index([customerId]) // NEW! Fast customer order lookup
  @@index([customerPhone])
  @@index([status])
  @@index([createdAt])
  @@index([chefId])
  @@index([parentOrderId])
  @@index([chefId, createdAt]) // Fast chef order history
  @@index([customerPhone, status]) // Fast customer order lookup
  @@index([status, deliveredAt]) // Fast analytics queries
  @@index([paymentStatus, createdAt]) // Payment tracking
}

model OrderItem {
  id      String @id @default(cuid())
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String

  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])
  menuItemId String

  quantity Int
  price    Float // Price at time of order (for historical accuracy)
  subtotal Float // quantity * price

  specialInstructions String?

  @@index([orderId])
  @@index([menuItemId])
}

enum OrderStatus {
  PENDING_CONFIRMATION // Waiting for cancellation window to expire (not visible to kitchen)
  PENDING // Just received (visible to kitchen after confirmation)
  CONFIRMED // Restaurant confirmed
  PREPARING // Being cooked
  READY // Ready for pickup/delivery
  OUT_FOR_DELIVERY // On the way
  DELIVERED // Completed
  CANCELLED // Cancelled by customer or restaurant
}

enum PaymentStatus {
  PENDING // Not paid yet
  PAID // Payment received
  FAILED // Payment failed
  REFUNDED // Money returned
}

// ===== CART INVENTORY TRACKING (NEW!) =====

// Track temporary cart reservations (soft locks for urgency system)
model CartReservation {
  id         String   @id @default(cuid())
  sessionId  String // Unique session/user ID (browser fingerprint)
  menuItemId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  quantity   Int

  createdAt DateTime @default(now())
  expiresAt DateTime // 30 minutes from creation (auto-cleanup)

  @@index([menuItemId])
  @@index([sessionId])
  @@index([expiresAt])
  @@index([createdAt])
}

// Track item demand patterns for ML-powered predictions and analytics
model ItemDemandHistory {
  id         String   @id @default(cuid())
  menuItemId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  timestamp DateTime @default(now())
  hour      Int // Hour of day (0-23) for pattern analysis

  addedToCarts Int @default(0) // How many carts added this hour
  ordered      Int @default(0) // How many actually ordered
  viewCount    Int @default(0) // How many viewed item (future feature)

  // Aggregated metrics
  demandScore Float @default(0) // Average demand pressure score

  @@unique([menuItemId, timestamp])
  @@index([menuItemId])
  @@index([timestamp])
  @@index([hour])
}

// ===== RECEIPT GENERATION =====

model Receipt {
  id            String @id @default(cuid())
  receiptNumber String @unique // Human-readable (e.g., "RCP-2024-001")

  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String @unique

  // Receipt Data (snapshot at time of generation)
  receiptData Json // Complete order details as JSON

  // PDF Storage
  pdfUrl      String? // URL to stored PDF
  pdfPublicId String? // Cloud storage ID

  // Timestamps
  generatedAt DateTime  @default(now())
  emailedAt   DateTime?

  @@index([receiptNumber])
  @@index([orderId])
}

// ===== ADMIN MANAGEMENT =====

model Admin {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  passwordHash String
  role         AdminRole @default(STAFF)

  isActive                 Boolean   @default(true)
  emailVerified            Boolean   @default(false)
  emailVerificationToken   String?
  emailVerificationExpires DateTime?

  passwordResetToken   String?
  passwordResetExpires DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  @@index([email])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
}

enum AdminRole {
  OWNER // Full access
  MANAGER // Can manage menu and orders
  STAFF // Can view and update orders only
}

// ===== PAYMENT TRACKING =====

model Payment {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Payment Gateway Info
  paymentGateway       String // "stripe", "razorpay", "cash", "cod"
  paymentMethodDetails String? // Specific method: "paytm", "form-b", "google-pay", "phonepe", "card", "netbanking", etc.
  paymentIntentId      String? // Stripe payment intent ID or Razorpay order ID
  transactionId        String? @unique // CRITICAL FIX: Unique constraint prevents duplicate payment processing from race conditions
  gatewayResponse      String? // JSON response from payment gateway

  // Amount Details
  amount     Float // Amount received (in paise/cents)
  currency   String @default("INR")
  gatewayFee Float  @default(0) // Fee charged by payment gateway
  netAmount  Float // amount - gatewayFee (actual money you receive)
  tip        Float  @default(0) // Tip amount included in payment

  // Status
  status        PaymentStatus @default(PENDING)
  failureReason String?

  // Bank Transfer Info
  payoutId     String? // Stripe payout ID or Razorpay transfer ID
  payoutStatus String? // "pending", "in_transit", "paid", "failed"
  payoutDate   DateTime? // When money was transferred to bank

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  paidAt     DateTime? // When payment was successfully received
  refundedAt DateTime?

  @@index([orderId])
  @@index([paymentIntentId])
  // @@index([transactionId]) // REMOVED: Now using @@unique constraint instead
  @@index([status])
  @@index([createdAt])
  @@index([payoutStatus])
  @@index([status, createdAt]) // Fast payment status queries
  @@index([paymentGateway, status]) // Gateway-specific queries

  /**
   * DATA INTEGRITY CONSTRAINTS (Added during comprehensive bug audit)
   * - transactionId is unique to prevent duplicate payment processing
   * - This prevents race conditions when multiple webhooks arrive simultaneously
   */
}

// ===== ANALYTICS & INSIGHTS =====

model DailySales {
  id   String   @id @default(cuid())
  date DateTime @unique

  totalOrders       Int   @default(0)
  totalRevenue      Float @default(0)
  totalTax          Float @default(0)
  totalDeliveryFees Float @default(0)

  averageOrderValue Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
}

// ===== CUSTOMER DATABASE WITH AUTHENTICATION =====

model Customer {
  id    String @id @default(cuid())
  name  String
  email String @unique
  phone String @unique

  // Authentication (NEW!)
  passwordHash String? // bcrypt hash (nullable for social login in future)

  // Email Verification (NEW!)
  emailVerified            Boolean   @default(false)
  emailVerificationToken   String?   @unique
  emailVerificationExpires DateTime?

  // Phone Verification (NEW!)
  phoneVerified             Boolean   @default(false)
  phoneVerificationOTP      String?
  phoneVerificationExpires  DateTime?
  phoneVerificationAttempts Int       @default(0)

  // Password Reset (NEW!)
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?

  // Account Status (NEW!)
  accountStatus String @default("ACTIVE") // ACTIVE, SUSPENDED, DELETED

  // Referral Code (NEW!)
  referralCode String? @unique // User's unique referral code (e.g., "RAVI-FEAST")
  referredBy   String? // ID of user who referred this user

  // Login Tracking (NEW!)
  loginAttempts Int       @default(0)
  lastLoginAt   DateTime?
  lastLoginIP   String?

  // Saved addresses
  addresses CustomerAddress[]

  // Loyalty
  totalOrders   Int   @default(0)
  totalSpent    Float @default(0)
  loyaltyPoints Int   @default(0)

  // First Order Discount (NEW!)
  firstOrderEligible Boolean @default(true) // Auto-20% discount on first order

  // Terms and Conditions Acceptance (NEW!)
  termsAccepted              Boolean @default(false)
  termsAcceptedAt            DateTime?
  termsVersion               String? // Version of terms accepted (e.g., "1.0")

  // Preferences
  dietaryPreferences String? // JSON array string for SQLite compatibility
  favoriteItems      String? // JSON array string for SQLite compatibility
  notificationPrefs  String? // JSON string: { email: true, sms: false, whatsapp: true }

  // Relations (NEW!)
  sessions           UserSession[]
  couponsUsed        CouponUsage[]
  referralsMade      Referral[]           @relation("ReferrerRelation")
  referralsReceived  Referral[]           @relation("RefereeRelation")
  orders             Order[]              @relation("CustomerOrders")
  wallet             Wallet? // Genius referral wallet
  referralMilestones ReferralMilestone[] // Jackpot milestones

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastOrderAt DateTime?

  @@index([email])
  @@index([phone])
  @@index([referralCode])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
  @@index([accountStatus])
}

model CustomerAddress {
  id         String   @id @default(cuid())
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId String

  label     String // "Home", "Work", etc.
  address   String
  city      String
  zipCode   String
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
}

// ===== NOTIFICATION TRACKING =====

model NotificationLog {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  type      String // email, sms, push, whatsapp
  channel   String // order_confirmation, status_update, payment_confirmation
  recipient String // email address or phone number
  status    String // sent, failed, pending

  sentAt       DateTime?
  failedAt     DateTime?
  errorMessage String?
  retryCount   Int       @default(0)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([status])
  @@index([createdAt])
}

// ===== COUPON & REFERRAL SYSTEM =====

model Coupon {
  id   String @id @default(cuid())
  code String @unique // "WELCOME20", "RAVI-FEAST" - CRITICAL: Unique to prevent duplicate coupons

  // Type & Ownership
  type      String // "MERCHANT" (admin-created) or "REFERRAL" (user-generated)
  createdBy String? // Admin ID (for merchant coupons) or Customer ID (for referral coupons)

  // Discount Configuration
  discountType   String // "PERCENTAGE" or "FIXED_AMOUNT"
  discountValue  Float // 20 for 20%, 50 for ₹50
  maxDiscountCap Float? // Max discount for percentage-based (e.g., ₹100 max on 20% off)
  minOrderAmount Float  @default(0) // Minimum order amount to apply coupon

  // Usage Limits
  maxUsageTotal   Int? // Total uses allowed (null = unlimited)
  maxUsagePerUser Int  @default(1) // Uses per user (default: 1)
  usageCount      Int  @default(0) // WARNING: Race condition possible - should use atomic increment

  // Validity
  validFrom  DateTime  @default(now())
  validUntil DateTime?
  isActive   Boolean   @default(true)

  // Restrictions
  firstOrderOnly       Boolean @default(false) // Only for first-time users
  applicableCategories String? // JSON array of category names (null = all categories)

  // Description
  title       String? // "Welcome Offer", "Friend Referral"
  description String? // "Get 20% off on your first order"

  // Relations
  usages CouponUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([type])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@index([createdBy])
}

model CouponUsage {
  id String @id @default(cuid())

  // Relations
  couponId String
  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  orderId String @unique // One coupon per order
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Discount Applied
  discountAmount Float // Actual discount given (e.g., ₹50)
  orderTotal     Float // Total before discount
  finalTotal     Float // Total after discount

  // Metadata
  usedAt    DateTime @default(now())
  ipAddress String? // Track for fraud prevention

  @@unique([couponId, orderId]) // Prevent duplicate usage
  @@index([couponId])
  @@index([customerId])
  @@index([orderId])
  @@index([usedAt])
}

model Referral {
  id String @id @default(cuid())

  // Participants
  referrerId String // User who shared the code
  referrer   Customer @relation("ReferrerRelation", fields: [referrerId], references: [id], onDelete: Cascade)

  refereeId String // User who used the code
  referee   Customer @relation("RefereeRelation", fields: [refereeId], references: [id], onDelete: Cascade)

  // Referral Details
  referralCode String // Code that was used

  // Rewards
  referrerReward Float @default(0) // Points or discount for referrer
  refereeReward  Float @default(0) // Discount for referee

  // Status
  status String @default("PENDING") // PENDING, COMPLETED, EXPIRED, PENDING_VERIFICATION

  // Conversion Tracking
  firstOrderId String? // Referee's first order (triggers reward)
  completedAt  DateTime? // When referral was completed
  
  // Fraud Detection (NEW!)
  fraudScore         Int      @default(0) // Risk score 0-100
  deliveryConfirmed  Boolean  @default(false) // Confirmed delivery before reward
  ipAddress          String? // IP address of referee at signup
  deviceFingerprint  String? // Browser fingerprint
  rewardPaidAt       DateTime? // When wallet credit was issued
  
  // Auto-discount tracking
  refereeDiscountApplied Boolean @default(false) // Whether referee got their ₹50 discount

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([refereeId]) // Each user can be referred only once
  @@index([referrerId])
  @@index([refereeId])
  @@index([referralCode])
  @@index([status])
  @@index([fraudScore])
  @@index([deliveryConfirmed])
}

// ===== WALLET SYSTEM (GENIUS REFERRAL REWARDS) =====

model Wallet {
  id         String @id @default(cuid())
  customerId String @unique
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Balance tracking
  balance     Float @default(0) // Current available balance
  totalEarned Float @default(0) // Lifetime earnings
  totalSpent  Float @default(0) // Lifetime spending
  
  // Pending balance (24-hour hold for fraud prevention)
  pendingBalance Float @default(0) // Amount waiting for clearance
  
  // Relations
  transactions WalletTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([balance])
}

model WalletTransaction {
  id       String @id @default(cuid())
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  // Transaction details
  type   String // CREDIT, DEBIT, PENDING_CREDIT
  amount Float // Transaction amount
  
  // Source tracking
  source      String // REFERRAL_REWARD, JACKPOT, ORDER_PAYMENT, ADMIN_CREDIT, REFUND
  sourceId    String? // referralId, milestoneId, or orderId
  description String? // Human-readable description
  
  // Balance snapshot
  balanceAfter        Float // Balance after this transaction
  pendingBalanceAfter Float @default(0) // Pending balance after transaction
  
  // Clearance tracking (for pending credits)
  clearsAt  DateTime? // When pending credit becomes available
  clearedAt DateTime? // When actually cleared
  
  // Metadata
  metadata String? // JSON string for additional data
  
  createdAt DateTime @default(now())

  @@index([walletId])
  @@index([type])
  @@index([source])
  @@index([createdAt])
  @@index([clearsAt])
}

model ReferralMilestone {
  id         String @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Milestone details
  milestoneType String // FIFTH_REFERRAL, TENTH_REFERRAL, TWENTIETH_REFERRAL, MONTHLY_CHAMPION
  milestoneCount Int // 5, 10, 20, etc.
  rewardAmount   Float // Jackpot amount (₹200-₹1000 for referrals, ₹5000 for champion)
  
  // Status
  status String @default("PENDING") // PENDING, PAID, CANCELLED
  
  // Payment tracking
  triggeredAt DateTime @default(now())
  paidAt      DateTime?
  
  // Associated transaction
  transactionId String? // WalletTransaction ID when paid
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([milestoneType])
  @@index([status])
  @@index([triggeredAt])
}

// ===== USER SESSION MANAGEMENT =====

model UserSession {
  id String @id @default(cuid())

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Token
  tokenHash String @unique // SHA-256 hash of JWT token

  // Session Info
  expiresAt DateTime
  isRevoked Boolean  @default(false)

  // Device Tracking
  userAgent  String?
  ipAddress  String?
  deviceInfo String? // JSON string: { os, browser, device }

  // Timestamps
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())

  @@index([customerId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([isRevoked])
}

// ===== SMART KITCHEN INTELLIGENCE SYSTEM =====

// Real-time kitchen capacity tracking for dynamic pricing
model KitchenCapacity {
  id           String   @id @default(cuid())
  restaurantId String   @default("default") // Multi-tenant support
  timestamp    DateTime @default(now())

  // Capacity Metrics
  currentOrders        Int // Orders being prepared now
  maxCapacity          Int // Maximum concurrent orders kitchen can handle
  utilizationPercent   Float // Calculated: (currentOrders / maxCapacity) * 100
  estimatedWaitMinutes Int // Estimated wait time for new orders
  staffOnDuty          Int // Number of staff currently working

  // Kitchen State
  status String @default("OPERATIONAL") // OPERATIONAL, OVERWHELMED, IDLE, CLOSED

  @@index([restaurantId, timestamp])
  @@index([timestamp])
  @@index([restaurantId])
}

// Ingredient-level inventory tracking for waste prevention
model IngredientInventory {
  id           String @id @default(cuid())
  name         String // "Chicken Breast", "Tomato", "Butter"
  restaurantId String @default("default")

  // Stock Information
  currentStock Float // Quantity in stock (e.g., 5.5)
  unit         String // "kg", "liters", "pieces", "grams"
  costPerUnit  Float // Procurement cost per unit

  // Expiry Tracking
  expiryDate       DateTime // When this batch expires
  hoursUntilExpiry Int // Calculated field for quick queries

  // Reordering
  minimumStock  Float // Reorder threshold
  lastRestocked DateTime @default(now())

  // Relations to Menu Items
  affectedMenuItems String? // JSON array of menu item IDs that use this ingredient

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId, expiryDate])
  @@index([hoursUntilExpiry])
  @@index([name])
  @@index([expiryDate])
}

// ML training data for demand forecasting
model DemandPrediction {
  id         String   @id @default(cuid())
  menuItemId String
  timestamp  DateTime @default(now())

  // Time Features
  hourOfDay Int // 0-23
  dayOfWeek Int // 0-6 (0 = Sunday)
  isHoliday Boolean @default(false)
  isWeekend Boolean @default(false)

  // External Features
  weatherCondition String? // "sunny", "rainy", "cold", "hot"
  temperature      Float? // Temperature in Celsius

  // Historical Context
  rollingAvg7Days  Float? // 7-day rolling average for this item
  rollingAvg30Days Float? // 30-day rolling average

  // Ground Truth (Actual Data)
  actualOrders Int @default(0) // What actually happened

  // Model Predictions
  predictedOrders    Int? // What the model predicted
  predictionAccuracy Float? // How accurate was the prediction (0-100%)

  // Confidence
  confidence      Float? // Model confidence (0-1)
  confidenceLower Int? // Lower bound of confidence interval
  confidenceUpper Int? // Upper bound of confidence interval

  // Model Info
  modelVersion String? // Track which model version made prediction

  @@unique([menuItemId, timestamp])
  @@index([menuItemId])
  @@index([timestamp])
  @@index([hourOfDay, dayOfWeek])
  @@index([menuItemId, hourOfDay])
}

// Price adjustment tracking and analytics
model DynamicPricing {
  id         String   @id @default(cuid())
  menuItemId String
  timestamp  DateTime @default(now())

  // Pricing
  originalPrice   Float // Base price from menu
  adjustedPrice   Float // Dynamically calculated price
  discountPercent Float @default(0) // Percentage discount/increase

  // Adjustment Factors
  adjustmentReason String // PEAK_DEMAND, LOW_CAPACITY, EXPIRY_RISK, IDLE_KITCHEN, SURGE_PRICING
  demandScore      Float  @default(0) // 0-100
  capacityScore    Float  @default(0) // 0-100
  expiryScore      Float  @default(0) // 0-100

  // Algorithm Tracking
  algorithmVersion String @default("v1.0")

  // Context at Time of Pricing
  kitchenUtilization Float? // Kitchen capacity at this moment
  predictedDemand    Int? // Forecasted orders for next hour
  hoursToExpiry      Float? // Hours until ingredients expire

  // Customer Impact
  timesViewed    Int    @default(0) // How many customers saw this price
  conversionRate Float? // % who bought at this price

  @@index([menuItemId, timestamp])
  @@index([timestamp])
  @@index([adjustmentReason])
  @@index([menuItemId])
}

// Comprehensive order metrics for ML training
model OrderMetrics {
  id        String   @id @default(cuid())
  orderId   String   @unique
  timestamp DateTime @default(now())

  // Timing Features
  orderPlacedHour   Int // 0-23
  orderPlacedDay    Int // 0-6
  orderPlacedMinute Int // 0-59 for granular patterns

  // Order Performance
  preparationTime Int? // Actual minutes taken to prepare
  deliveryTime    Int? // Actual minutes taken to deliver
  totalTime       Int? // Order to delivery total time

  // Kitchen State at Order Time
  kitchenUtilization Float? // Kitchen capacity when order placed
  ordersInQueue      Int? // How many orders ahead
  staffOnDuty        Int?

  // Order Details
  itemsPurchased String // JSON array of {itemId, quantity, price}
  itemCount      Int // Total number of items
  totalValue     Float // Order total

  // External Context
  weatherAtTime     String? // Weather condition when ordered
  temperatureAtTime Float? // Temperature when ordered

  // Customer Behavior
  customerIsReturning Boolean @default(false) // Is this a repeat customer?
  daysSinceLastOrder  Int? // For repeat customers

  // Outcome
  wasCompleted       Boolean @default(true) // Did order complete successfully?
  wasCancelled       Boolean @default(false)
  cancellationReason String? // If cancelled

  @@index([orderId])
  @@index([timestamp])
  @@index([orderPlacedHour, orderPlacedDay])
}

// ===== LEGAL COMPLIANCE & DATA PROTECTION =====

// Legal acceptance tracking (mandatory before usage)
model LegalAcceptance {
  id            String   @id @default(cuid())
  userId        String?
  sessionId     String   // For non-logged-in users
  documentType  String   // "TERMS", "PRIVACY", "REFUND", "FOOD_SAFETY"
  version       String   // "2.0", "3.0"
  acceptedAt    DateTime @default(now())
  ipAddress     String
  userAgent     String
  acceptMethod  String   // "MODAL", "CHECKBOX", "SIGNUP"
  
  @@index([userId])
  @@index([sessionId])
  @@index([documentType, version])
}

// Data retention for tax compliance (7 years)
model ArchivedOrder {
  id              String   @id @default(cuid())
  originalOrderId String   @unique
  orderData       Json     // Complete order snapshot
  archivedAt      DateTime @default(now())
  retainUntil     DateTime // 7 years from order date
  taxYear         String   // "FY2024-25"
  financialPeriod String   // "Q1", "Q2", "Q3", "Q4"
  
  @@index([retainUntil])
  @@index([taxYear])
}

// Data retention audit log
model DataRetentionLog {
  id          String   @id @default(cuid())
  recordType  String   // "order", "payment", "user"
  recordId    String
  action      String   // "archived", "deleted", "retained", "reviewed"
  reason      String   // "tax_compliance", "legal_hold", "gdpr_request"
  performedAt DateTime @default(now())
  performedBy String?  // Admin ID if manual
  details     Json?    // Additional context
  
  @@index([recordType])
  @@index([performedAt])
}

// Security breach tracking (72-hour notification)
model SecurityBreach {
  id              String   @id @default(cuid())
  severity        String   // "CRITICAL", "HIGH", "MEDIUM", "LOW"
  breachType      String   // "unauthorized_access", "data_leak", "sql_injection"
  affectedRecords Int
  affectedUsers   Json     // Array of user IDs/emails
  detectedAt      DateTime @default(now())
  notifiedAt      DateTime? // Must be within 72 hours
  resolvedAt      DateTime?
  dpbReportedAt   DateTime? // Data Protection Board notification
  description     String
  rootCause       String?
  mitigationSteps Json
  
  @@index([detectedAt])
  @@index([severity])
  @@index([notifiedAt])
}

// DPO request tracking (30-day SLA)
model DPORequest {
  id              String   @id @default(cuid())
  userId          String?
  email           String
  phone           String?
  requestType     String   // "DATA_ACCESS", "DATA_DELETION", "DATA_CORRECTION", "CONSENT_WITHDRAWAL"
  description     String
  requestedAt     DateTime @default(now())
  dueDate         DateTime // 30 days from request (DPDPA § 12(2))
  acknowledgedAt  DateTime?
  respondedAt     DateTime?
  status          String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, REJECTED
  response        String?
  rejectionReason String?
  isOverdue       Boolean  @default(false)
  escalatedAt     DateTime?
  
  @@index([requestType])
  @@index([dueDate])
  @@index([isOverdue])
  @@index([status])
}

// Cookie consent tracking (GDPR/DPDPA)
model CookieConsent {
  id               String   @id @default(cuid())
  userId           String?
  sessionId        String
  essential        Boolean  @default(true)  // Always true (required)
  analytics        Boolean  @default(false)
  marketing        Boolean  @default(false)
  consentedAt      DateTime @default(now())
  lastUpdated      DateTime @updatedAt
  ipAddress        String?
  userAgent        String?
  withdrawnAt      DateTime?
  
  @@index([userId])
  @@index([sessionId])
  @@index([consentedAt])
}

// User deletion requests (Right to Erasure)
model UserDeletionRequest {
  id              String   @id @default(cuid())
  userId          String   @unique
  reason          String?
  requestedAt     DateTime @default(now())
  gracePeriodEnds DateTime // 30 days from request
  cancelledAt     DateTime?
  executedAt      DateTime?
  hasLegalHold    Boolean  @default(false) // Pending litigation
  hasActiveOrders Boolean  @default(false) // Orders not yet delivered
  legalHoldReason String?
  
  @@index([userId])
  @@index([gracePeriodEnds])
  @@index([executedAt])
}

// Compliance alerts and notifications
model ComplianceAlert {
  id          String   @id @default(cuid())
  alertType   String   // "RETENTION_DUE", "BREACH_DETECTED", "DPO_OVERDUE", "LICENSE_EXPIRING"
  severity    String   // "CRITICAL", "HIGH", "MEDIUM", "LOW"
  title       String
  description String
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?
  assignedTo  String?  // Admin ID
  
  @@index([alertType])
  @@index([severity])
  @@index([resolvedAt])
}

// Comprehensive audit log for all compliance actions
model AuditLog {
  id          String   @id @default(cuid())
  action      String   // "LOGIN_FAILED", "DATA_ACCESSED", "LEGAL_ACCEPTED", "BREACH_DETECTED", etc.
  entityType  String   // "user", "order", "security_breach", "dpo_request", etc.
  entityId    String?  // ID of affected entity
  userId      String?  // User who performed action (if applicable)
  sessionId   String?  // Session ID for anonymous actions
  ipAddress   String?
  userAgent   String?
  details     Json?    // Additional context
  createdAt   DateTime @default(now())
  
  @@index([action])
  @@index([entityType])
  @@index([userId])
  @@index([createdAt])
  @@index([ipAddress])
}

// ===== DATABASE-LEVEL AUDIT TRAIL (GENIUS ARCHITECTURE) =====

// Database change tracking - logs all DDL/DML operations for complete audit trail
// This provides defense-in-depth: even if app-level logging fails, database changes are captured
model DatabaseChange {
  id              String   @id @default(cuid())
  occurredAt      DateTime @default(now())
  actor           String?  // User ID or system role
  clientAddr      String?  // IP address
  appName         String   @default("bantus-kitchen") // Application identifier
  txId            String?  // Transaction ID for grouping related changes
  changeKind      String   // 'ddl', 'dml', 'storage'
  commandTag      String?  // 'CREATE TABLE', 'INSERT', 'UPDATE', 'DELETE', etc.
  objectType      String?  // 'table', 'column', 'index', 'trigger'
  objectIdentity  String?  // Fully qualified name (schema.table)
  statement       String?  @db.Text // SQL statement text (when available)
  details         Json?    // Additional metadata (old/new values, row count, etc.)
  
  @@index([occurredAt])
  @@index([changeKind])
  @@index([objectType])
  @@index([actor])
  @@index([commandTag])
  @@map("database_changes")
}

// ===== ADVANCED RECOMMENDATION SYSTEM =====

// Thompson Sampling Multi-Armed Bandit Statistics
// Tracks impressions and conversions for exploration/exploitation
model BanditStats {
  id          String   @id @default(cuid())
  itemId      String   @unique // MenuItem ID
  impressions Int      @default(0) // Times shown to users
  conversions Int      @default(0) // Times added to cart/ordered
  alpha       Float    @default(1) // Beta distribution α parameter
  beta        Float    @default(1) // Beta distribution β parameter
  updatedAt   DateTime @updatedAt

  @@index([itemId])
  @@index([updatedAt])
}

// Collaborative Filtering - User-Item Interactions
// Tracks user preferences with temporal decay
model UserItemInteraction {
  id          String   @id @default(cuid())
  customerId  String
  itemId      String
  interaction String   // "view", "add_to_cart", "order", "favorite"
  weight      Float    @default(1.0) // Interaction strength
  createdAt   DateTime @default(now())

  @@unique([customerId, itemId, interaction])
  @@index([customerId])
  @@index([itemId])
  @@index([createdAt])
}

// Affinity Rules - Association Mining Results
// "Customers who bought A also bought B"
model AffinityRule {
  id          String   @id @default(cuid())
  antecedent  String   // JSON array of item IDs (if part)
  consequent  String   // JSON array of item IDs (then part)
  support     Float    // How often pattern occurs (0-1)
  confidence  Float    // P(consequent|antecedent) (0-1)
  lift        Float    // Confidence / P(consequent)
  orderCount  Int      @default(0)
  updatedAt   DateTime @updatedAt

  @@unique([antecedent, consequent])
  @@index([support])
  @@index([confidence])
  @@index([lift])
}

// Trending Velocity Tracking
// Tracks order velocity over time windows
model ItemVelocity {
  id            String   @id @default(cuid())
  itemId        String
  windowHours   Int      // Time window (1, 3, 6, 24, etc.)
  orderCount    Int      @default(0)
  velocity      Float    @default(0) // Orders per hour change
  percentChange Float    @default(0)
  momentum      String   @default("stable") // "rising", "stable", "falling"
  windowStart   DateTime
  windowEnd     DateTime
  createdAt     DateTime @default(now())

  @@unique([itemId, windowHours, windowStart])
  @@index([itemId])
  @@index([velocity])
  @@index([momentum])
  @@index([windowStart])
}

// A/B Test Assignments
// Track which algorithm variant users see
model ABTestAssignment {
  id          String   @id @default(cuid())
  sessionId   String
  customerId  String?
  variant     String   // "A", "B", "C"
  algorithm   String   // "recommendation_engine", "trending_display", etc.
  assignedAt  DateTime @default(now())

  @@unique([sessionId, algorithm])
  @@index([sessionId])
  @@index([customerId])
  @@index([variant])
  @@index([algorithm])
}

// Recommendation Performance Metrics
// Track how well recommendations perform
model RecommendationMetric {
  id              String   @id @default(cuid())
  sessionId       String
  customerId      String?
  itemId          String
  algorithm       String   // Which algorithm recommended it
  variant         String?  // A/B test variant
  rank            Int      // Position in recommendations (1-based)
  score           Float    // Recommendation score
  shown           Boolean  @default(false) // Was it displayed?
  clicked         Boolean  @default(false) // Did user click/view?
  addedToCart     Boolean  @default(false) // Did user add to cart?
  ordered         Boolean  @default(false) // Did user order?
  shownAt         DateTime @default(now())
  clickedAt       DateTime?
  addedToCartAt   DateTime?
  orderedAt       DateTime?

  @@index([sessionId])
  @@index([customerId])
  @@index([itemId])
  @@index([algorithm])
  @@index([variant])
  @@index([shownAt])
}

// ===== ADVANCED DRIVER & DELIVERY SYSTEM =====

// Driver/Delivery Agent Management
model Driver {
  id              String   @id @default(cuid())
  userId          String?  @unique // Link to Customer model if driver has customer account

  // Personal Information
  name            String
  phone           String   @unique
  email           String   @unique
  profilePhoto    String?
  dateOfBirth     DateTime?

  // Verification & Documents
  verificationStatus String @default("pending") // pending, verified, rejected
  licenseNumber      String? @unique
  licenseFrontPhoto  String?
  licenseBackPhoto   String?
  licenseExpiry      DateTime?
  vehicleType        String? // bike, scooter, car
  vehicleNumber      String? @unique
  vehiclePhoto       String?
  insuranceNumber    String?
  insuranceExpiry    DateTime?
  backgroundCheck    Boolean @default(false)

  // Location & Availability
  currentLat         Float?
  currentLng         Float?
  lastLocationUpdate DateTime?
  isOnline           Boolean  @default(false)
  isAvailable        Boolean  @default(false)
  currentZone        String?  // Zone/area name
  homeZone           String?  // Preferred operating zone

  // Performance Metrics
  rating             Float    @default(5.0)
  ratingCount        Int      @default(0)
  totalDeliveries    Int      @default(0)
  completedToday     Int      @default(0)
  completedThisWeek  Int      @default(0)
  acceptanceRate     Float    @default(100.0) // % of orders accepted
  completionRate     Float    @default(100.0) // % of accepted orders completed
  onTimeRate         Float    @default(100.0) // % delivered on time
  averageDeliveryTime Float   @default(0)     // Minutes

  // Earnings
  totalEarnings      Float    @default(0)
  todayEarnings      Float    @default(0)
  weekEarnings       Float    @default(0)
  monthEarnings      Float    @default(0)
  pendingBalance     Float    @default(0)

  // Gamification
  level              Int      @default(1)
  experiencePoints   Int      @default(0)
  currentStreak      Int      @default(0)  // Consecutive days worked
  longestStreak      Int      @default(0)
  badges             String?  // JSON array of badge IDs

  // Banking & Payouts
  bankName           String?
  accountNumber      String?
  ifscCode           String?
  upiId              String?
  panNumber          String?

  // Status & Compliance
  status             String   @default("active") // active, inactive, suspended, blocked
  suspensionReason   String?
  lastActiveAt       DateTime?
  joinedAt           DateTime @default(now())

  // Relations
  deliveries         Delivery[]
  earnings           DriverEarning[]
  shifts             DriverShift[]
  ratings            DriverRating[]
  badges_earned      DriverBadge[]
  notifications      DriverNotification[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([phone])
  @@index([email])
  @@index([isOnline])
  @@index([isAvailable])
  @@index([currentZone])
  @@index([status])
  @@index([rating])
}

// Individual Delivery/Trip
model Delivery {
  id                  String   @id @default(cuid())
  orderId             String   @unique
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  driverId            String
  driver              Driver   @relation(fields: [driverId], references: [id])

  // Delivery Details
  status              String   @default("assigned") // assigned, picked_up, in_transit, arrived, delivered, failed
  pickupLat           Float
  pickupLng           Float
  pickupAddress       String
  dropoffLat          Float
  dropoffLng          Float
  dropoffAddress      String
  distance            Float?   // km
  estimatedDuration   Int?     // minutes

  // Timestamps
  assignedAt          DateTime @default(now())
  acceptedAt          DateTime?
  pickedUpAt          DateTime?
  arrivedAt           DateTime?
  deliveredAt         DateTime?

  // Proof of Delivery
  deliveryPhoto       String?
  deliveryNotes       String?
  signatureUrl        String?
  customerName        String?

  // Route Optimization
  routePolyline       String?  @db.Text // Encoded polyline for map display
  routeSteps          String?  @db.Text // JSON array of turn-by-turn directions
  actualRoute         String?  @db.Text // Actual GPS breadcrumbs (JSON)

  // Financials
  baseFare            Float    @default(0)
  distanceFare        Float    @default(0)
  timeFare            Float    @default(0)
  surgeFare           Float    @default(0)
  tip                 Float    @default(0)
  totalEarning        Float    @default(0)

  // Performance
  onTime              Boolean  @default(true)
  delayMinutes        Int      @default(0)
  customerRating      Int?     // 1-5 stars
  customerFeedback    String?

  // Failure Tracking
  failureReason       String?
  failurePhoto        String?
  reattemptCount      Int      @default(0)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([driverId])
  @@index([orderId])
  @@index([status])
  @@index([assignedAt])
  @@index([deliveredAt])
}

// Real-time GPS Location Tracking
model DriverLocation {
  id          String   @id @default(cuid())
  driverId    String
  lat         Float
  lng         Float
  speed       Float?   // km/h
  heading     Float?   // degrees (0-360)
  accuracy    Float?   // meters
  altitude    Float?   // meters
  timestamp   DateTime @default(now())

  @@index([driverId])
  @@index([timestamp])
}

// Driver Shift Management
model DriverShift {
  id            String    @id @default(cuid())
  driverId      String
  driver        Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)

  shiftStart    DateTime
  shiftEnd      DateTime?
  duration      Int?      // minutes

  // Location tracking
  startLat      Float?
  startLng      Float?
  endLat        Float?
  endLng        Float?

  // Performance during shift
  deliveries    Int       @default(0)
  earnings      Float     @default(0)
  distance      Float     @default(0) // km
  activeTime    Int       @default(0) // minutes actually on delivery
  idleTime      Int       @default(0) // minutes waiting for orders

  status        String    @default("active") // active, ended

  createdAt     DateTime  @default(now())

  @@index([driverId])
  @@index([shiftStart])
  @@index([status])
}

// Driver Earnings Breakdown
model DriverEarning {
  id              String   @id @default(cuid())
  driverId        String
  driver          Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  deliveryId      String?

  // Earning Components
  type            String   // delivery, bonus, incentive, tip, referral
  amount          Float
  description     String?

  // Payout Status
  status          String   @default("pending") // pending, paid, cancelled
  paidAt          DateTime?
  payoutMethod    String?  // bank_transfer, upi, wallet
  transactionId   String?

  // Metadata
  date            DateTime @default(now())
  weekNumber      Int?     // Week of year
  monthNumber     Int?     // 1-12

  createdAt       DateTime @default(now())

  @@index([driverId])
  @@index([type])
  @@index([status])
  @@index([date])
}

// Driver Ratings from Customers
model DriverRating {
  id          String   @id @default(cuid())
  driverId    String
  driver      Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  orderId     String
  customerId  String

  rating      Int      // 1-5 stars
  feedback    String?
  tags        String?  // JSON array: ["friendly", "fast", "professional"]

  createdAt   DateTime @default(now())

  @@unique([orderId])
  @@index([driverId])
  @@index([rating])
  @@index([createdAt])
}

// Gamification Badges
model DriverBadge {
  id          String   @id @default(cuid())
  driverId    String
  driver      Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  badgeId     String   // Badge identifier (e.g., "speedster", "reliable", "top_earner")
  badgeName   String
  badgeIcon   String?
  badgeColor  String?
  level       String?  // bronze, silver, gold, platinum

  progress    Int      @default(0)  // Progress towards next level
  maxProgress Int      @default(100)

  earnedAt    DateTime @default(now())

  @@unique([driverId, badgeId, level])
  @@index([driverId])
  @@index([badgeId])
}

// Smart Notifications for Drivers
model DriverNotification {
  id          String    @id @default(cuid())
  driverId    String
  driver      Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)

  type        String    // new_order, surge_alert, bonus_available, shift_reminder, rating_received
  title       String
  message     String
  priority    String    @default("normal") // low, normal, high, urgent

  actionUrl   String?
  actionLabel String?

  isRead      Boolean   @default(false)
  readAt      DateTime?

  // Rich notification data
  data        Json?     // Additional metadata

  expiresAt   DateTime?
  createdAt   DateTime  @default(now())

  @@index([driverId])
  @@index([isRead])
  @@index([priority])
  @@index([createdAt])
}

// Heat Map Data - Demand Zones
model DemandZone {
  id                String   @id @default(cuid())
  name              String
  centerLat         Float
  centerLng         Float
  radius            Float    // meters

  // Demand Metrics
  currentDemand     Int      @default(0)  // Active orders
  availableDrivers  Int      @default(0)
  demandScore       Float    @default(0)  // 0-1 score
  surgeMultiplier   Float    @default(1.0)

  // Time-based patterns
  hourlyPattern     String?  @db.Text // JSON array of hourly demand
  weeklyPattern     String?  @db.Text // JSON array of daily demand

  // Configuration
  isActive          Boolean  @default(true)
  color             String   @default("#FF6B35") // Hex color for heat map

  updatedAt         DateTime @updatedAt
  createdAt         DateTime @default(now())

  @@index([demandScore])
  @@index([surgeMultiplier])
  @@index([isActive])
}

// Batch Delivery Optimization
model DeliveryBatch {
  id              String   @id @default(cuid())
  driverId        String

  status          String   @default("active") // active, completed, cancelled
  orderIds        String   // JSON array of order IDs

  // Route Optimization
  optimizedRoute  String   @db.Text // JSON array of waypoints in optimal order
  totalDistance   Float?   // km
  totalDuration   Int?     // minutes

  // Earnings
  batchBonus      Float    @default(0)
  totalEarnings   Float    @default(0)

  startedAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([driverId])
  @@index([status])
  @@index([startedAt])
}

// Order Assignment Algorithm Tracking
model OrderAssignment {
  id                  String   @id @default(cuid())
  orderId             String   @unique

  // Assignment Algorithm
  algorithm           String   // nearest, smart_routing, load_balancing, ml_based
  assignedDriverId    String?
  rejectedDriverIds   String?  // JSON array of drivers who declined

  // Metrics
  searchRadius        Float?   // km
  driversNotified     Int      @default(0)
  responseTime        Int?     // seconds until accepted

  // Optimization scores
  distanceScore       Float?
  timeScore           Float?
  driverScore         Float?   // Based on ratings, completion rate
  finalScore          Float?

  assignedAt          DateTime @default(now())

  @@index([orderId])
  @@index([assignedDriverId])
  @@index([algorithm])
}

// Revenue Optimization Insights
model RevenueInsight {
  id          String   @id @default(cuid())
  driverId    String

  // Time-based insights
  date        DateTime
  hour        Int      // 0-23
  dayOfWeek   Int      // 0-6

  // Performance metrics
  orders      Int      @default(0)
  earnings    Float    @default(0)
  distance    Float    @default(0)
  activeTime  Int      @default(0)

  // Zone performance
  zone        String?
  demandLevel String?  // low, medium, high

  createdAt   DateTime @default(now())

  @@unique([driverId, date, hour])
  @@index([driverId])
  @@index([date])
  @@index([earnings])
}

// ===== COMPREHENSIVE ANALYTICS & TRACKING SYSTEM =====

// User Sessions - Track every visitor
model UserSession {
  id              String   @id @default(cuid())
  sessionId       String   @unique // Generated client-side, persistent
  fingerprintId   String?  // Device fingerprint for tracking across sessions

  // User Info
  userId          String?  // If logged in
  isAuthenticated Boolean  @default(false)
  userType        String?  // customer, admin, driver, guest

  // Geographic Location
  ipAddress       String?
  country         String?
  countryCode     String?  // US, IN, GB, etc.
  region          String?  // State/Province
  city            String?
  zipCode         String?
  latitude        Float?
  longitude       Float?
  timezone        String?
  isp             String?  // Internet Service Provider

  // Device & Browser Info
  userAgent       String?  @db.Text
  browser         String?  // Chrome, Firefox, Safari, etc.
  browserVersion  String?
  os              String?  // Windows, macOS, iOS, Android, Linux
  osVersion       String?
  device          String?  // desktop, mobile, tablet
  deviceVendor    String?  // Apple, Samsung, etc.
  deviceModel     String?
  screenWidth     Int?
  screenHeight    Int?
  language        String?  // en-US, hi-IN, etc.

  // Traffic Source
  referrer        String?  @db.Text // Previous URL
  referrerDomain  String?
  utmSource       String?  // google, facebook, email, etc.
  utmMedium       String?  // cpc, organic, email, social
  utmCampaign     String?
  utmTerm         String?
  utmContent      String?

  // Session Metrics
  landingPage     String?  @db.Text
  exitPage        String?  @db.Text
  pageViewCount   Int      @default(0)
  clickCount      Int      @default(0)
  duration        Int      @default(0) // seconds
  bounced         Boolean  @default(false) // Single page visit
  converted       Boolean  @default(false) // Completed goal

  // Timestamps
  startedAt       DateTime @default(now())
  lastActivityAt  DateTime @default(now())
  endedAt         DateTime?

  // Relations
  pageViews       PageView[]
  clickEvents     ClickEvent[]
  interactions    UserInteraction[]
  conversions     Conversion[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sessionId])
  @@index([fingerprintId])
  @@index([userId])
  @@index([ipAddress])
  @@index([country])
  @@index([city])
  @@index([startedAt])
  @@index([converted])
}

// Page Views - Every page visited
model PageView {
  id              String      @id @default(cuid())
  sessionId       String
  session         UserSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  // Page Info
  url             String      @db.Text
  path            String      // /menu, /admin, /checkout
  title           String?
  referrer        String?     @db.Text

  // Performance Metrics
  loadTime        Int?        // milliseconds
  timeOnPage      Int?        // seconds
  scrollDepth     Int?        // 0-100%

  // Exit tracking
  isExit          Boolean     @default(false)
  exitedAt        DateTime?

  viewedAt        DateTime    @default(now())

  @@index([sessionId])
  @@index([path])
  @@index([viewedAt])
}

// Click Events - Every click tracked
model ClickEvent {
  id              String      @id @default(cuid())
  sessionId       String
  session         UserSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  // Click Details
  page            String      // Which page
  elementType     String?     // button, link, image, input
  elementId       String?     // HTML id attribute
  elementClass    String?     // HTML class
  elementText     String?     @db.Text // Button text or link text
  elementSelector String?     @db.Text // CSS selector

  // Position
  xPosition       Int?        // X coordinate on page
  yPosition       Int?        // Y coordinate on page

  // Context
  targetUrl       String?     @db.Text // Where click leads

  clickedAt       DateTime    @default(now())

  @@index([sessionId])
  @@index([page])
  @@index([elementType])
  @@index([clickedAt])
}

// User Interactions - Form submissions, searches, etc.
model UserInteraction {
  id              String      @id @default(cuid())
  sessionId       String
  session         UserSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  // Interaction Details
  type            String      // search, form_submit, add_to_cart, filter_change, etc.
  page            String

  // Data
  data            Json?       // Interaction-specific data
  value           String?     @db.Text // Search query, form values, etc.

  // Metadata
  duration        Int?        // Time spent on interaction (ms)
  successful      Boolean     @default(true)
  errorMessage    String?

  createdAt       DateTime    @default(now())

  @@index([sessionId])
  @@index([type])
  @@index([page])
  @@index([createdAt])
}

// Conversions - Goal completions
model Conversion {
  id              String      @id @default(cuid())
  sessionId       String
  session         UserSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  // Conversion Details
  goalType        String      // order_placed, signup, newsletter, download, etc.
  goalValue       Float?      // Monetary value (order amount, etc.)

  // Journey
  touchpoints     Int         @default(1) // How many interactions before conversion
  timeToConvert   Int?        // Seconds from session start to conversion

  // Attribution
  firstSource     String?     // First touch attribution
  lastSource      String?     // Last touch attribution

  // Order Info (if applicable)
  orderId         String?
  orderValue      Float?

  convertedAt     DateTime    @default(now())

  @@index([sessionId])
  @@index([goalType])
  @@index([convertedAt])
}

// Location Analytics - Aggregated by location
model LocationAnalytics {
  id              String   @id @default(cuid())

  // Location
  country         String
  countryCode     String
  region          String?
  city            String?
  latitude        Float?
  longitude       Float?

  // Date
  date            DateTime // Day-level aggregation

  // Metrics
  sessions        Int      @default(0)
  uniqueUsers     Int      @default(0)
  pageViews       Int      @default(0)
  clicks          Int      @default(0)
  conversions     Int      @default(0)
  totalRevenue    Float    @default(0)
  avgSessionDuration Int   @default(0) // seconds
  bounceRate      Float    @default(0) // percentage

  updatedAt       DateTime @updatedAt

  @@unique([country, city, date])
  @@index([country])
  @@index([city])
  @@index([date])
  @@index([sessions])
}

// Click Heatmap Data - For heatmap visualization
model HeatmapData {
  id              String   @id @default(cuid())

  // Page
  path            String   // /menu, /checkout, etc.

  // Click Position
  xPosition       Int
  yPosition       Int

  // Aggregation
  clickCount      Int      @default(1)
  date            DateTime

  // Viewport info (for responsive heatmaps)
  screenWidth     Int?
  screenHeight    Int?

  updatedAt       DateTime @updatedAt

  @@unique([path, xPosition, yPosition, date])
  @@index([path])
  @@index([date])
  @@index([clickCount])
}

// User Journey - Path through website
model UserJourney {
  id              String      @id @default(cuid())
  sessionId       String

  // Journey Path
  steps           Json        // Array of pages visited in order
  duration        Int         // Total journey time (seconds)

  // Outcome
  converted       Boolean     @default(false)
  conversionType  String?
  exitPage        String?

  createdAt       DateTime    @default(now())

  @@index([sessionId])
  @@index([converted])
  @@index([createdAt])
}

// Traffic Source Analytics - Aggregated by source
model TrafficSource {
  id              String   @id @default(cuid())

  // Source
  source          String   // google, facebook, direct, etc.
  medium          String?  // organic, cpc, email, social
  campaign        String?

  // Date
  date            DateTime

  // Metrics
  sessions        Int      @default(0)
  users           Int      @default(0)
  conversions     Int      @default(0)
  revenue         Float    @default(0)
  avgSessionDuration Int   @default(0)
  bounceRate      Float    @default(0)

  updatedAt       DateTime @updatedAt

  @@unique([source, medium, campaign, date])
  @@index([source])
  @@index([date])
}

// Real-time Analytics - Current active users
model RealTimeAnalytics {
  id              String   @id @default(cuid())

  // Current Stats (last 5 minutes)
  activeUsers     Int      @default(0)
  activeSessions  Json?    // Array of active session IDs
  topPages        Json?    // Array of top pages right now
  topLocations    Json?    // Array of top cities/countries
  recentEvents    Json?    // Last 10 events

  // Snapshot time
  timestamp       DateTime @default(now())

  @@index([timestamp])
}

// Device Fingerprint - For user identification across sessions
model DeviceFingerprint {
  id              String   @id @default(cuid())
  fingerprintId   String   @unique

  // Fingerprint Components
  userAgent       String?  @db.Text
  screenResolution String?
  timezone        String?
  language        String?
  platform        String?
  plugins         String?  @db.Text
  canvas          String?  // Canvas fingerprint
  webgl           String?  // WebGL fingerprint
  fonts           String?  @db.Text // Installed fonts

  // Tracking
  firstSeen       DateTime @default(now())
  lastSeen        DateTime @default(now())
  sessionCount    Int      @default(0)

  @@index([fingerprintId])
  @@index([lastSeen])
}

// ===== RATINGS & REVIEWS SYSTEM =====

// Dish/Menu Item Ratings (only from verified purchasers)
model DishRating {
  id              String   @id @default(cuid())
  menuItemId      String
  menuItem        MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  // Customer Info
  customerId      String?  // If logged in
  customerName    String
  orderId         String   // Verified purchase
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Rating Components (1-5 stars each)
  overallRating   Int      // Overall experience (1-5)
  tasteRating     Int?     // How it tasted (1-5)
  presentationRating Int?  // Visual appeal (1-5)
  portionRating   Int?     // Portion size (1-5)
  valueRating     Int?     // Value for money (1-5)
  freshnessRating Int?     // Freshness of ingredients (1-5)

  // Review
  title           String?  // Review headline
  review          String?  @db.Text // Detailed review

  // Sentiment Analysis (auto-generated)
  sentiment       String?  // positive, neutral, negative
  sentimentScore  Float?   // -1 to 1

  // Tags (customer-selected or auto-detected)
  tags            String?  @db.Text // JSON: ["spicy", "authentic", "fresh", "delicious"]

  // Media
  photos          String?  @db.Text // JSON array of photo URLs

  // Helpful votes
  helpfulCount    Int      @default(0)
  notHelpfulCount Int      @default(0)

  // Verification
  isVerifiedPurchase Boolean @default(true)

  // Moderation
  isApproved      Boolean  @default(false)
  isFlagged       Boolean  @default(false)
  flagReason      String?
  moderatedAt     DateTime?
  moderatedBy     String?

  // Response from restaurant
  response        String?  @db.Text
  respondedAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([orderId, menuItemId]) // One rating per item per order
  @@index([menuItemId])
  @@index([customerId])
  @@index([orderId])
  @@index([overallRating])
  @@index([createdAt])
  @@index([isApproved])
}

// ===== ADVANCED ANALYTICS FOR DATA MONETIZATION =====

// Taste Preference Profiling (GOLD DATA!)
model TastePreference {
  id              String   @id @default(cuid())
  customerId      String?
  fingerprintId   String?  // For anonymous users

  // Flavor Preferences (0-1 scale, learned from ratings)
  spicyPreference    Float @default(0.5)
  sweetPreference    Float @default(0.5)
  sourPreference     Float @default(0.5)
  saltyPreference    Float @default(0.5)
  bitterPreference   Float @default(0.5)
  umamiPreference    Float @default(0.5)
  creamyPreference   Float @default(0.5)
  crunchyPreference  Float @default(0.5)

  // Cuisine Preferences
  cuisineScores      Json? // {"Indian": 0.9, "Chinese": 0.7, "Italian": 0.6}

  // Dietary Patterns
  vegetarianScore    Float @default(0.5) // Likelihood of being vegetarian
  veganScore         Float @default(0.5)
  healthConscious    Float @default(0.5)
  adventurous        Float @default(0.5) // Tries new things

  // Price Sensitivity
  priceElasticity    Float @default(0.5) // 0 = price insensitive, 1 = very sensitive
  avgOrderValue      Float @default(0)
  maxOrderValue      Float @default(0)

  // Ordering Patterns
  lunchFrequency     Float @default(0)
  dinnerFrequency    Float @default(0)
  weekendFrequency   Float @default(0)

  // Last updated
  updatedAt          DateTime @updatedAt
  createdAt          DateTime @default(now())

  @@index([customerId])
  @@index([fingerprintId])
}

// Menu Item Performance Analytics
model MenuItemAnalytics {
  id              String   @id @default(cuid())
  menuItemId      String
  date            DateTime // Daily aggregation

  // Sales Metrics
  ordersCount     Int      @default(0)
  quantity        Int      @default(0)
  revenue         Float    @default(0)

  // Rating Metrics
  avgRating       Float?
  ratingCount     Int      @default(0)

  // Component Ratings
  avgTaste        Float?
  avgPresentation Float?
  avgPortion      Float?
  avgValue        Float?
  avgFreshness    Float?

  // Sentiment
  positiveReviews Int      @default(0)
  neutralReviews  Int      @default(0)
  negativeReviews Int      @default(0)

  // Return Rate
  repeatOrders    Int      @default(0) // Same customer ordered again
  repeatRate      Float?   // Percentage

  // Pairing Analytics (GOLD!)
  frequentPairs   Json?    // Items often ordered with this one

  // Time-based patterns
  morningOrders   Int      @default(0)
  afternoonOrders Int      @default(0)
  eveningOrders   Int      @default(0)
  nightOrders     Int      @default(0)

  // Weather correlation (GOLD!)
  rainyDayOrders  Int      @default(0)
  sunnyDayOrders  Int      @default(0)
  coldDayOrders   Int      @default(0)
  hotDayOrders    Int      @default(0)

  updatedAt       DateTime @updatedAt

  @@unique([menuItemId, date])
  @@index([menuItemId])
  @@index([date])
  @@index([avgRating])
  @@index([revenue])
}

// Customer Lifetime Value Prediction (GOLD!)
model CustomerLTV {
  id              String   @id @default(cuid())
  customerId      String   @unique

  // Historical Data
  firstOrderDate  DateTime
  lastOrderDate   DateTime
  totalOrders     Int      @default(0)
  totalSpent      Float    @default(0)
  avgOrderValue   Float    @default(0)

  // Predicted Future Value
  predictedLTV    Float?   // Next 12 months
  ltv30Days       Float?
  ltv90Days       Float?
  ltv365Days      Float?

  // Churn Prediction
  churnRisk       Float?   // 0-1, probability of not ordering again
  churnScore      String?  // low, medium, high

  // Engagement Metrics
  daysSinceLastOrder Int   @default(0)
  avgDaysBetweenOrders Float @default(0)
  orderFrequency   String? // daily, weekly, monthly, occasional

  // Segmentation
  segment          String? // vip, regular, at_risk, churned, new

  // Monetization Potential
  upsellPotential  Float?  // Likelihood to buy premium items
  referralPotential Float? // Likelihood to refer others

  updatedAt        DateTime @updatedAt
  createdAt        DateTime @default(now())

  @@index([customerId])
  @@index([predictedLTV])
  @@index([churnRisk])
  @@index([segment])
}

// Food Trend Detection (GOLD!)
model FoodTrend {
  id              String   @id @default(cuid())

  // Trend Identification
  trendName       String   // e.g., "Plant-based proteins", "Korean flavors"
  category        String?  // cuisine, ingredient, dietary, flavor

  // Metrics
  growthRate      Float    // Percentage growth
  velocity        Float    // Acceleration
  peakPrediction  DateTime? // When will it peak

  // Affected Items
  relatedItems    Json     // Menu items in this trend

  // Geographic
  topCities       Json?    // Where is this trending

  // Demographics
  ageGroup        String?  // Which age group drives this
  timeOfDay       String?  // When is it most popular

  // Monetization Score
  monetizationPotential Float? // How much can we capitalize

  // Status
  status          String   // emerging, growing, peaking, declining
  confidence      Float    // How confident in this trend (0-1)

  detectedAt      DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([trendName])
  @@index([status])
  @@index([growthRate])
}

// Viral Food Prediction (GOLD!)
model ViralPrediction {
  id              String   @id @default(cuid())
  menuItemId      String

  // Virality Indicators
  socialShareRate Float    @default(0) // How often shared
  photoUploadRate Float    @default(0) // How often photographed
  reviewRate      Float    @default(0) // Reviews per order
  repeatOrderRate Float    @default(0) // Reorders

  // Velocity Metrics
  orderVelocity   Float    @default(0) // Orders per day
  velocityGrowth  Float    @default(0) // Growth rate

  // Virality Score
  viralityScore   Float    @default(0) // 0-100
  viralPotential  String   // low, medium, high, viral

  // Prediction
  predictedOrders Int?     // Next 7 days
  peakDate        DateTime? // When will it peak

  // Recommendations
  actionItems     Json?    // What to do (increase stock, promote, etc.)

  calculatedAt    DateTime @default(now())

  @@unique([menuItemId])
  @@index([viralityScore])
  @@index([viralPotential])
}

// Price Optimization Analytics (GOLD!)
model PriceOptimization {
  id              String   @id @default(cuid())
  menuItemId      String

  // Current Pricing
  currentPrice    Float

  // Optimal Pricing
  recommendedPrice Float?
  minPrice        Float?   // Floor
  maxPrice        Float?   // Ceiling

  // Elasticity
  priceElasticity Float?   // How sensitive to price changes

  // Revenue Projection
  currentRevenue  Float    @default(0)
  projectedRevenue Float?  // At recommended price
  revenueUplift   Float?   // Potential increase %

  // Demand Curve Data
  demandCurve     Json?    // Price vs quantity data

  // A/B Test Results
  testPrices      Json?    // Prices tested
  testResults     Json?    // Results of tests

  // Competition
  competitorPrice Float?
  pricePosition   String?  // premium, competitive, value

  // Recommendations
  strategy        String?  // increase, decrease, maintain, dynamic
  confidence      Float?   // 0-1

  calculatedAt    DateTime @default(now())

  @@unique([menuItemId])
  @@index([recommendedPrice])
  @@index([revenueUplift])
}

// Ingredient Intelligence (GOLD!)
model IngredientTrend {
  id              String   @id @default(cuid())
  ingredientName  String   @unique

  // Popularity Metrics
  usageCount      Int      @default(0) // How many dishes use it
  orderFrequency  Float    @default(0) // Orders of dishes with this

  // Trend
  growthRate      Float    @default(0)
  trendDirection  String   @default("stable") // rising, stable, falling

  // Health Data
  healthScore     Float?   // Nutrition/health rating
  allergenInfo    String?  // Common allergen?

  // Sustainability
  sustainabilityScore Float? // Environmental impact
  localAvailability Boolean @default(true)

  // Pricing
  avgCost         Float?   // Cost per unit
  priceVolatility Float?   // How much price fluctuates

  // Seasonality
  seasonalPattern Json?    // When is it in season

  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  @@index([ingredientName])
  @@index([growthRate])
  @@index([trendDirection])
}

// Customer Segmentation (GOLD!)
model CustomerSegment {
  id              String   @id @default(cuid())
  segmentName     String   @unique

  // Segment Criteria
  criteria        Json     // Rules for this segment

  // Size
  customerCount   Int      @default(0)
  percentOfTotal  Float    @default(0)

  // Value
  avgLTV          Float?
  totalRevenue    Float    @default(0)

  // Behavior
  avgOrderValue   Float?
  avgFrequency    Float?
  preferredTime   String?
  preferredItems  Json?

  // Marketing
  conversionRate  Float?
  responseRate    Float?   // To marketing campaigns

  // Recommendations
  targetingStrategy String? @db.Text
  recommendations Json?

  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  @@index([segmentName])
  @@index([customerCount])
}

// Competitive Intelligence (GOLD!)
model CompetitorAnalysis {
  id              String   @id @default(cuid())
  competitorName  String

  // Menu Comparison
  sharedItems     Json?    // Items both have
  uniqueItems     Json?    // Items only they have

  // Pricing
  avgPriceDiff    Float?   // How our prices compare

  // Performance
  estimatedOrders Int?
  marketShare     Float?

  // Strengths/Weaknesses
  strengths       String?  @db.Text
  weaknesses      String?  @db.Text

  // Opportunities
  gaps            String?  @db.Text // What we could add
  threats         String?  @db.Text

  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  @@index([competitorName])
}

// Seasonal Intelligence (GOLD!)
model SeasonalPattern {
  id              String   @id @default(cuid())
  itemType        String   // menu_item, category, cuisine
  itemId          String

  // Patterns
  monthlyPattern  Json     // Sales by month
  weeklyPattern   Json     // Sales by day of week
  hourlyPattern   Json     // Sales by hour

  // Weather Correlation
  weatherImpact   Json?    // How weather affects sales

  // Events
  eventImpact     Json?    // Festivals, holidays impact

  // Predictions
  nextPeak        DateTime?
  nextLow         DateTime?

  // Recommendations
  stockingAdvice  String?  @db.Text
  pricingAdvice   String?  @db.Text

  updatedAt       DateTime @updatedAt

  @@unique([itemType, itemId])
  @@index([itemType])
  @@index([itemId])
}

// ============================================================================
// 🤖 AI/ML INTELLIGENCE SYSTEM - Apple-Level Smart
// ============================================================================
// Revolutionary AI models that make the app feel magical
// Real predictions, real insights, real intelligence
// ============================================================================

// ===== PREDICTIVE AI MODELS =====

// AI Model Registry - Track all deployed ML models
model AIModel {
  id              String   @id @default(cuid())
  modelName       String   @unique // "churn_predictor_v3", "demand_forecaster_v2"
  modelType       String   // "classification", "regression", "timeseries", "nlp", "vision"
  version         String   // "3.2.1"

  // Model Architecture
  framework       String   // "tensorflow", "pytorch", "scikit", "prophet"
  algorithm       String   // "random_forest", "lstm", "transformer", "cnn"

  // Performance Metrics
  accuracy        Float?   // Classification accuracy
  precision       Float?   // Precision score
  recall          Float?   // Recall score
  f1Score         Float?   // F1 score
  mse             Float?   // Mean squared error (regression)
  mae             Float?   // Mean absolute error
  r2Score         Float?   // R² score

  // Training Data
  trainingSize    Int      // Number of samples
  features        Json     // Feature list and importance
  hyperparameters Json     // Model hyperparameters

  // Deployment
  status          String   @default("training") // training, testing, deployed, deprecated
  deployedAt      DateTime?
  lastTrainedAt   DateTime @default(now())

  // Performance Tracking
  totalPredictions Int     @default(0)
  avgLatency      Float?   // ms per prediction

  // Relations
  predictions     AIPrediction[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([modelType])
  @@index([status])
}

// AI Predictions - Store all AI predictions for tracking and learning
model AIPrediction {
  id              String   @id @default(cuid())
  modelId         String
  model           AIModel  @relation(fields: [modelId], references: [id])

  // Input
  entityType      String   // "customer", "order", "menu_item", "driver"
  entityId        String
  inputFeatures   Json     // Raw input data

  // Prediction
  predictionType  String   // "churn", "ltv", "demand", "rating", "eta"
  predictedValue  Float?   // Numeric prediction
  predictedClass  String?  // Classification prediction
  confidence      Float    // 0-1 confidence score
  probabilities   Json?    // Class probabilities

  // Explanation
  topFeatures     Json?    // SHAP values / feature importance
  explanation     String?  @db.Text // Human-readable explanation

  // Outcome (for model retraining)
  actualValue     Float?   // Ground truth (filled later)
  actualClass     String?
  wasCorrect      Boolean?
  error           Float?   // Prediction error

  // Metadata
  latency         Float?   // Prediction time in ms
  createdAt       DateTime @default(now())

  @@index([modelId])
  @@index([entityType, entityId])
  @@index([predictionType])
  @@index([createdAt])
}

// Real-Time Demand Forecasting
model DemandForecast {
  id              String   @id @default(cuid())

  // Target
  itemType        String   // "menu_item", "category", "cuisine"
  itemId          String
  itemName        String

  // Time Window
  forecastDate    DateTime
  forecastHour    Int?     // 0-23, null for daily forecast
  forecastWindow  String   // "hourly", "daily", "weekly"

  // Predictions
  predictedOrders Int
  predictedRevenue Float
  confidence      Float    // 0-1

  // Confidence Intervals
  ordersLowerBound Int?
  ordersUpperBound Int?

  // Contributing Factors
  weatherFactor   Float?   // Impact of weather (-1 to 1)
  eventFactor     Float?   // Impact of events/holidays
  trendFactor     Float?   // Trend momentum
  seasonalFactor  Float?   // Seasonal pattern

  // Context
  weather         String?  // "rainy", "sunny", "cold", "hot"
  isHoliday       Boolean  @default(false)
  isWeekend       Boolean  @default(false)
  specialEvent    String?

  // Recommendations
  stockingLevel   String?  // "low", "medium", "high", "very_high"
  pricingAdvice   String?  // "increase_10", "decrease_5", "maintain"
  marketingAdvice String?  @db.Text

  // Accuracy Tracking
  actualOrders    Int?     // Filled after forecast period
  actualRevenue   Float?
  forecastError   Float?   // Percentage error

  createdAt       DateTime @default(now())

  @@unique([itemType, itemId, forecastDate, forecastHour])
  @@index([itemType, itemId])
  @@index([forecastDate])
}

// Customer Churn Prediction with AI
model ChurnPrediction {
  id              String   @id @default(cuid())
  customerId      String   @unique

  // Prediction
  churnRisk       Float    // 0-1 probability of churning
  riskLevel       String   // "low", "medium", "high", "critical"
  churnDate       DateTime? // Predicted churn date

  // Contributing Factors (SHAP values)
  factorRecency   Float?   // Days since last order impact
  factorFrequency Float?   // Order frequency impact
  factorMonetary  Float?   // Spend amount impact
  factorRating    Float?   // Rating trend impact
  factorSupport   Float?   // Support tickets impact

  // Top Risk Indicators
  riskReasons     Json     // ["declining_frequency", "low_ratings", "competitor_switch"]

  // AI Recommendations
  retentionStrategy String? @db.Text // AI-generated retention plan
  recommendedAction String? // "send_coupon", "vip_upgrade", "personal_call"
  actionPriority    Int?    // 1-10

  // Intervention Tracking
  actionTaken     String?
  actionDate      DateTime?
  wasRetained     Boolean?

  // Model Performance
  modelVersion    String
  confidence      Float    // 0-1

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([riskLevel])
  @@index([churnRisk])
}

// Smart Price Optimization with AI
model DynamicPricing {
  id              String   @id @default(cuid())
  menuItemId      String

  // Current State
  currentPrice    Float
  basePrice       Float

  // AI Recommendations
  recommendedPrice Float
  priceChange     Float    // Percentage change
  confidence      Float    // 0-1

  // Expected Impact
  expectedDemandChange Float // Percentage
  expectedRevenueChange Float // Percentage
  expectedProfitChange Float // Percentage

  // Optimization Factors
  demandLevel     String   // "low", "medium", "high", "surge"
  competitorPrice Float?
  inventoryLevel  String?  // "low", "medium", "high"
  timeOfDay       String?  // "breakfast", "lunch", "dinner", "night"
  dayOfWeek       String?

  // Weather & Events
  weather         String?
  isEvent         Boolean  @default(false)
  eventType       String?

  // Strategy
  pricingStrategy String   // "maximize_revenue", "maximize_profit", "maximize_volume", "clearance"

  // A/B Testing
  isExperiment    Boolean  @default(false)
  experimentGroup String?  // "control", "test_a", "test_b"

  // Results (filled later)
  actualOrders    Int?
  actualRevenue   Float?
  wasSuccessful   Boolean?

  validFrom       DateTime @default(now())
  validUntil      DateTime?

  createdAt       DateTime @default(now())

  @@index([menuItemId])
  @@index([validFrom, validUntil])
}

// ===== AUTO-GENERATED INSIGHTS =====

// AI-Generated Insights - The "magic" that impresses users
model AIInsight {
  id              String   @id @default(cuid())

  // Insight Details
  insightType     String   // "trend", "anomaly", "opportunity", "risk", "prediction"
  category        String   // "sales", "customer", "operations", "finance", "marketing"

  // Content
  title           String   // "Sales spike on rainy days"
  description     String   @db.Text // Full insight description

  // Impact
  severity        String   // "low", "medium", "high", "critical"
  impact          String   // "positive", "negative", "neutral"
  impactValue     Float?   // Estimated $ impact

  // Data
  dataPoints      Json     // Supporting data
  visualization   String?  // "line_chart", "bar_chart", "heatmap", "gauge"

  // AI Recommendations
  recommendations Json     // List of actionable recommendations
  actionPriority  Int      // 1-10

  // Targeting
  audience        String   // "admin", "chef", "customer"
  entityType      String?  // "customer", "menu_item", "driver"
  entityId        String?

  // Status
  status          String   @default("new") // new, viewed, acted, dismissed, archived
  isActionable    Boolean  @default(true)

  // Engagement
  viewCount       Int      @default(0)
  viewedBy        Json?    // List of user IDs who viewed
  actionTaken     String?
  actionDate      DateTime?

  // Metadata
  confidence      Float?   // 0-1 confidence in insight
  source          String?  // Which AI model generated it
  expiresAt       DateTime? // Time-sensitive insights

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([insightType])
  @@index([category])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
}

// Anomaly Detection - Automatically detect unusual patterns
model AnomalyDetection {
  id              String   @id @default(cuid())

  // Anomaly Details
  anomalyType     String   // "fraud", "spike", "drop", "outlier", "pattern_break"
  entityType      String   // "order", "customer", "driver", "menu_item"
  entityId        String

  // Detection
  metric          String   // "order_value", "frequency", "rating", "delivery_time"
  expectedValue   Float
  actualValue     Float
  deviation       Float    // Standard deviations from normal

  // Severity
  severity        String   // "low", "medium", "high", "critical"
  confidence      Float    // 0-1

  // Context
  description     String   @db.Text
  possibleCauses  Json     // AI-generated hypotheses

  // Response
  status          String   @default("detected") // detected, investigating, resolved, false_positive
  needsAction     Boolean  @default(true)
  suggestedAction String?  @db.Text

  // Resolution
  actionTaken     String?
  resolvedBy      String?
  resolvedAt      DateTime?
  resolution      String?  @db.Text

  // Impact
  financialImpact Float?   // $ amount
  customerImpact  Int?     // Number of customers affected

  detectedAt      DateTime @default(now())

  @@index([anomalyType])
  @@index([severity])
  @@index([status])
  @@index([detectedAt])
}

// ===== COMPUTER VISION =====

// Food Image Recognition
model FoodImageAnalysis {
  id              String   @id @default(cuid())

  // Image
  imageUrl        String
  imageHash       String   @unique // Perceptual hash for duplicate detection

  // Source
  sourceType      String   // "menu_upload", "customer_review", "social_media"
  sourceId        String?
  menuItemId      String?

  // AI Vision Analysis
  detectedFood    String?  // Primary food detected
  foodConfidence  Float?   // 0-1

  // Multi-label Classification
  foodCategories  Json     // ["indian", "curry", "chicken", "spicy"]
  categoryScores  Json     // Confidence for each category

  // Quality Assessment
  visualAppeal    Float?   // 0-1 score
  platting        Float?   // Presentation score
  freshnessScore  Float?   // Freshness score
  portionSize     String?  // "small", "medium", "large"

  // Color Analysis
  dominantColors  Json     // RGB values
  colorPalette    Json     // Full palette
  colorfulness    Float?   // 0-1

  // Content Detection
  hasText         Boolean  @default(false)
  hasPerson       Boolean  @default(false)
  hasBranding     Boolean  @default(false)

  // Safety
  isAppropriate   Boolean  @default(true)
  nsfwScore       Float?   // 0-1

  // Recommendations
  isHighQuality   Boolean?
  suggestedPrice  Float?   // Price range based on visual appeal
  marketingReady  Boolean  @default(false)

  // Metadata
  modelVersion    String
  processingTime  Float?   // ms

  createdAt       DateTime @default(now())

  @@index([menuItemId])
  @@index([detectedFood])
}

// ===== NATURAL LANGUAGE PROCESSING =====

// Smart Search Query Analysis
model SearchQuery {
  id              String   @id @default(cuid())

  // Query
  rawQuery        String   @db.Text
  normalizedQuery String   // Cleaned, lowercased

  // User Context
  customerId      String?
  sessionId       String?

  // NLP Analysis
  intent          String?  // "find_food", "browse", "compare", "reorder"
  entities        Json?    // Extracted: cuisine, dish, price, etc.
  sentiment       String?  // "positive", "neutral", "negative"

  // Semantic Understanding
  semanticVector  String?  @db.Text // Embedding for semantic search
  relatedQueries  Json?    // Similar past queries

  // Query Enhancement
  suggestedQuery  String?
  autoCorrection  String?
  synonyms        Json?

  // Results
  resultCount     Int      @default(0)
  topResultId     String?
  wasSuccessful   Boolean?

  // User Behavior
  clickedResults  Json?    // Which results were clicked
  clickPosition   Int?     // Position of first click
  timeToClick     Float?   // Seconds
  addedToCart     Boolean  @default(false)

  // Learning
  feedbackScore   Float?   // User satisfaction

  createdAt       DateTime @default(now())

  @@index([customerId])
  @@index([normalizedQuery])
  @@index([intent])
  @@index([createdAt])
}

// Review Sentiment & Topic Analysis
model ReviewAnalysis {
  id              String   @id @default(cuid())
  reviewId        String   @unique // Links to DishRating or OrderReview
  reviewText      String   @db.Text

  // Sentiment Analysis
  sentiment       String   // "very_positive", "positive", "neutral", "negative", "very_negative"
  sentimentScore  Float    // -1 to 1
  confidence      Float    // 0-1

  // Emotion Detection
  emotions        Json     // {"joy": 0.8, "anger": 0.1, "sadness": 0.1}
  dominantEmotion String?

  // Topic Modeling
  topics          Json     // ["taste", "delivery", "packaging", "price"]
  topicScores     Json     // Relevance scores

  // Aspect-Based Sentiment
  tastesentiment  Float?   // -1 to 1
  deliverySentiment Float?
  packagingSentiment Float?
  valuesentiment   Float?

  // Key Phrases
  keyPhrases      Json     // Important phrases extracted

  // Urgency Detection
  isUrgent        Boolean  @default(false)
  needsResponse   Boolean  @default(false)
  priority        Int?     // 1-10

  // Auto-Response
  suggestedReply  String?  @db.Text
  replyTone       String?  // "apologetic", "grateful", "neutral"

  // Language
  language        String   @default("en")

  createdAt       DateTime @default(now())

  @@index([sentiment])
  @@index([needsResponse])
}

// ===== SMART AUTOMATION =====

// Smart Notifications Engine
model SmartNotification {
  id              String   @id @default(cuid())

  // Target
  recipientType   String   // "customer", "chef", "driver", "admin"
  recipientId     String

  // Notification Details
  channel         String   // "push", "email", "sms", "in_app"
  title           String
  message         String   @db.Text

  // AI Optimization
  priority        String   // "low", "medium", "high", "urgent"
  optimalTime     DateTime? // AI-calculated best time to send

  // Personalization
  personalization Json?    // Dynamic content
  template        String?

  // Trigger
  triggerType     String   // "event", "prediction", "schedule", "anomaly"
  triggerData     Json?

  // Delivery
  status          String   @default("scheduled") // scheduled, sent, delivered, read, clicked, dismissed
  sentAt          DateTime?
  deliveredAt     DateTime?
  readAt          DateTime?
  clickedAt       DateTime?

  // Engagement
  wasClicked      Boolean  @default(false)
  clickedLink     String?
  conversionValue Float?   // $ value of action taken

  // A/B Testing
  experimentId    String?
  variant         String?  // "A", "B", "C"

  // Learning
  engagementScore Float?   // 0-1

  createdAt       DateTime @default(now())

  @@index([recipientType, recipientId])
  @@index([status])
  @@index([optimalTime])
}

// Auto-Generated Actions & Workflows
model AIAction {
  id              String   @id @default(cuid())

  // Action Details
  actionType      String   // "send_coupon", "price_adjustment", "inventory_alert", "churn_prevention"
  targetType      String   // "customer", "menu_item", "driver"
  targetId        String

  // Trigger
  triggeredBy     String   // Which AI system triggered it
  triggerReason   String   @db.Text
  confidence      Float    // 0-1

  // Action Plan
  actionPlan      Json     // Detailed steps
  expectedOutcome String?  @db.Text
  expectedValue   Float?   // Expected $ impact

  // Approval
  requiresApproval Boolean @default(false)
  status          String   @default("pending") // pending, approved, executed, failed, cancelled
  approvedBy      String?
  approvedAt      DateTime?

  // Execution
  executedAt      DateTime?
  executionDetails Json?

  // Results
  actualOutcome   String?  @db.Text
  actualValue     Float?   // Actual $ impact
  wasSuccessful   Boolean?

  // Learning
  feedbackScore   Float?   // For model improvement

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([actionType])
  @@index([status])
  @@index([targetType, targetId])
}

// ===== INTELLIGENT A/B TESTING =====

// Smart A/B Testing with Multi-Armed Bandits
model ABTest {
  id              String   @id @default(cuid())

  // Test Details
  testName        String   @unique
  testType        String   // "price", "ui", "notification", "recommendation"
  description     String   @db.Text

  // Target
  entityType      String   // "menu_item", "feature", "campaign"
  entityId        String?

  // Variants
  variants        Json     // [{"id": "A", "config": {...}}, {"id": "B", ...}]

  // Algorithm
  algorithm       String   @default("thompson_sampling") // "thompson_sampling", "epsilon_greedy", "ucb"

  // Metrics
  primaryMetric   String   // "conversion", "revenue", "engagement"
  secondaryMetrics Json?

  // Status
  status          String   @default("draft") // draft, running, paused, completed, archived
  startedAt       DateTime?
  endedAt         DateTime?

  // Auto-Optimization
  autoOptimize    Boolean  @default(true)
  minSampleSize   Int      @default(100)
  confidenceLevel Float    @default(0.95)

  // Results
  winner          String?  // Variant ID
  confidenceScore Float?
  liftPercent     Float?

  // Relation
  results         ABTestResult[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([testType])
}

// A/B Test Results (per variant)
model ABTestResult {
  id              String   @id @default(cuid())
  testId          String
  test            ABTest   @relation(fields: [testId], references: [id], onDelete: Cascade)

  variant         String   // "A", "B", "C"

  // Impressions & Conversions
  impressions     Int      @default(0)
  conversions     Int      @default(0)
  conversionRate  Float    @default(0)

  // Revenue
  totalRevenue    Float    @default(0)
  avgRevenue      Float    @default(0)

  // Engagement
  totalEngagement Float    @default(0)
  avgEngagement   Float    @default(0)

  // Thompson Sampling Parameters
  alpha           Float    @default(1)  // Successes + 1
  beta            Float    @default(1)  // Failures + 1

  // Statistics
  confidence      Float?   // Confidence vs control
  pValue          Float?

  updatedAt       DateTime @updatedAt

  @@unique([testId, variant])
  @@index([testId])
}

// ===== REAL-TIME INTELLIGENCE =====

// Real-Time Business Metrics Dashboard
model RealtimeMetrics {
  id              String   @id @default(cuid())

  // Timestamp (minute-level granularity)
  timestamp       DateTime @unique

  // Orders
  activeOrders    Int      @default(0)
  ordersPerMinute Float    @default(0)
  avgOrderValue   Float    @default(0)

  // Customers
  activeUsers     Int      @default(0)
  newSignups      Int      @default(0)

  // Drivers
  onlineDrivers   Int      @default(0)
  busyDrivers     Int      @default(0)
  avgDeliveryTime Float?

  // Revenue
  revenuePerMinute Float   @default(0)

  // AI Predictions
  predictedNext5Min Float? // Predicted orders in next 5 min
  predictedNext15Min Float?
  predictedNext60Min Float?

  // Alerts
  anomalyDetected Boolean  @default(false)
  alertLevel      String?  // "normal", "warning", "critical"

  @@index([timestamp])
}

// Event Stream - All important events in real-time
model EventStream {
  id              String   @id @default(cuid())

  // Event
  eventType       String   // "order_placed", "payment_success", "delivery_complete", "review_posted"
  eventCategory   String   // "order", "customer", "driver", "finance"

  // Entities
  entityType      String?
  entityId        String?

  // Data
  eventData       Json     // Full event payload

  // AI Processing
  processed       Boolean  @default(false)
  processedAt     DateTime?
  aiInsights      Json?    // AI-generated insights from event

  // Impact
  businessImpact  String?  // "high", "medium", "low"
  revenueImpact   Float?

  timestamp       DateTime @default(now())

  @@index([eventType])
  @@index([eventCategory])
  @@index([timestamp])
  @@index([processed])
}
